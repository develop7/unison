<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="annot"><span class="hs-comment">-- | Rewrites of some codebase queries, but which check the scratch file for info first.</span></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.LSP.Queries</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.LSP.Queries.html#markdownDocsForFQN"><span class="hs-identifier">markdownDocsForFQN</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#getTypeOfReferent"><span class="hs-identifier">getTypeOfReferent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#getTypeDeclaration"><span class="hs-identifier">getTypeDeclaration</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#refAtPosition"><span class="hs-identifier">refAtPosition</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#nodeAtPosition"><span class="hs-identifier">nodeAtPosition</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#refInTerm"><span class="hs-identifier">refInTerm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#refInType"><span class="hs-identifier">refInType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier">findSmallestEnclosingNode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier">findSmallestEnclosingType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#refInDecl"><span class="hs-identifier">refInDecl</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Unison.LSP.Queries.html#SourceNode"><span class="hs-identifier">SourceNode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lens</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Generics.Product</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">field</span></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Types</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ABT</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ABT</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Builtin.Decls</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Builtins</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Codebase</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ConstructorType</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CT</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decl</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DD</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.HashQualified</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HQ</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Conversions.html"><span class="hs-identifier">Unison.LSP.Conversions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Conversions.html#lspToUPos"><span class="hs-identifier">lspToUPos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.FileAnalysis.html"><span class="hs-identifier">Unison.LSP.FileAnalysis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.FileAnalysis.html#getFileSummary"><span class="hs-identifier">getFileSummary</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.LSP.FileAnalysis.html#ppedForFile"><span class="hs-identifier">ppedForFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Orphans.html"><span class="hs-identifier">Unison.LSP.Orphans</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html"><span class="hs-identifier">Unison.LSP.Types</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.LabeledDependency</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.LabeledDependency</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LD</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Lexer.Pos</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Pos</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.NamesWithHistory</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SearchType</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ann</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Pattern</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pattern</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TypeReference</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Reference</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Referent</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Referent</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Server.Backend</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Backend</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Server.Doc.Markdown.Render</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Md</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Server.Doc.Markdown.Types</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Md</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.Parser</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MatchCase</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MatchCase</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Term</span></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Term</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Type</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile.Summary</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FileSummary</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Pretty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pretty</span></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="annot"><span class="hs-comment">-- | Returns a reference to whatever the symbol at the given position refers to.</span></span><span>
</span><span id="line-62"></span><span class="annot"><a href="Unison.LSP.Queries.html#refAtPosition"><span class="hs-identifier hs-type">refAtPosition</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Uri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LabeledDependency</span></span><span>
</span><span id="line-63"></span><span id="refAtPosition"><span class="annot"><span class="annottext">refAtPosition :: Uri -&gt; Position -&gt; MaybeT Lsp LabeledDependency
</span><a href="Unison.LSP.Queries.html#refAtPosition"><span class="hs-identifier hs-var hs-var">refAtPosition</span></a></span></span><span> </span><span id="local-6989586621680958452"><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958452"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span id="local-6989586621680958453"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621680958453"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Lsp LabeledDependency
</span><a href="#local-6989586621680958454"><span class="hs-identifier hs-var">findInNode</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp LabeledDependency
-&gt; MaybeT Lsp LabeledDependency -&gt; MaybeT Lsp LabeledDependency
forall a. MaybeT Lsp a -&gt; MaybeT Lsp a -&gt; MaybeT Lsp a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp LabeledDependency
</span><a href="#local-6989586621680958456"><span class="hs-identifier hs-var">findInDecl</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><a href="#local-6989586621680958454"><span class="hs-identifier hs-type">findInNode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LabeledDependency</span></span><span>
</span><span id="line-67"></span><span>    </span><span id="local-6989586621680958454"><span class="annot"><span class="annottext">findInNode :: MaybeT Lsp LabeledDependency
</span><a href="#local-6989586621680958454"><span class="hs-identifier hs-var hs-var">findInNode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-68"></span><span>      </span><span class="annot"><span class="annottext">Uri -&gt; Position -&gt; MaybeT Lsp (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#nodeAtPosition"><span class="hs-identifier hs-var">nodeAtPosition</span></a></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958452"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621680958453"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp (SourceNode Ann)
-&gt; (SourceNode Ann -&gt; MaybeT Lsp LabeledDependency)
-&gt; MaybeT Lsp LabeledDependency
forall a b. MaybeT Lsp a -&gt; (a -&gt; MaybeT Lsp b) -&gt; MaybeT Lsp b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-69"></span><span>        </span><span class="annot"><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-type">TermNode</span></a></span><span> </span><span id="local-6989586621680958458"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958458"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency -&gt; MaybeT Lsp LabeledDependency
forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958459"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe LabeledDependency -&gt; MaybeT Lsp LabeledDependency)
-&gt; Maybe LabeledDependency -&gt; MaybeT Lsp LabeledDependency
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Maybe LabeledDependency
forall v a. Term v a -&gt; Maybe LabeledDependency
</span><a href="Unison.LSP.Queries.html#refInTerm"><span class="hs-identifier hs-var">refInTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958458"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-70"></span><span>        </span><span class="annot"><a href="Unison.LSP.Queries.html#TypeNode"><span class="hs-identifier hs-type">TypeNode</span></a></span><span> </span><span id="local-6989586621680958461"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958461"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency -&gt; MaybeT Lsp LabeledDependency
forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958459"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe LabeledDependency -&gt; MaybeT Lsp LabeledDependency)
-&gt; Maybe LabeledDependency -&gt; MaybeT Lsp LabeledDependency
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeReference -&gt; LabeledDependency)
-&gt; Maybe TypeReference -&gt; Maybe LabeledDependency
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">TypeReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Maybe TypeReference
forall v a. Type v a -&gt; Maybe TypeReference
</span><a href="Unison.LSP.Queries.html#refInType"><span class="hs-identifier hs-var">refInType</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958461"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>        </span><span class="annot"><a href="Unison.LSP.Queries.html#PatternNode"><span class="hs-identifier hs-type">PatternNode</span></a></span><span> </span><span id="local-6989586621680958464"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958464"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency -&gt; MaybeT Lsp LabeledDependency
forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958459"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe LabeledDependency -&gt; MaybeT Lsp LabeledDependency)
-&gt; Maybe LabeledDependency -&gt; MaybeT Lsp LabeledDependency
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe LabeledDependency
forall a. Pattern a -&gt; Maybe LabeledDependency
</span><a href="Unison.LSP.Queries.html#refInPattern"><span class="hs-identifier hs-var">refInPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958464"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><a href="#local-6989586621680958456"><span class="hs-identifier hs-type">findInDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LabeledDependency</span></span><span>
</span><span id="line-73"></span><span>    </span><span id="local-6989586621680958456"><span class="annot"><span class="annottext">findInDecl :: MaybeT Lsp LabeledDependency
</span><a href="#local-6989586621680958456"><span class="hs-identifier hs-var hs-var">findInDecl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-74"></span><span>      </span><span class="annot"><span class="annottext">TypeReference -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">LD.TypeReference</span></span><span> </span><span class="annot"><span class="annottext">(TypeReference -&gt; LabeledDependency)
-&gt; MaybeT Lsp TypeReference -&gt; MaybeT Lsp LabeledDependency
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-75"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958467"><span class="annot"><span class="annottext">uPos :: Pos
</span><a href="#local-6989586621680958467"><span class="hs-identifier hs-var hs-var">uPos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Position -&gt; Pos
</span><a href="Unison.LSP.Conversions.html#lspToUPos"><span class="hs-identifier hs-var">lspToUPos</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621680958453"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-76"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FileSummary</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680958469"><span class="annot"><span class="annottext">Map Symbol (Id, DataDeclaration Symbol Ann)
dataDeclsBySymbol :: Map Symbol (Id, DataDeclaration Symbol Ann)
$sel:dataDeclsBySymbol:FileSummary :: FileSummary -&gt; Map Symbol (Id, DataDeclaration Symbol Ann)
</span><a href="#local-6989586621680958469"><span class="hs-identifier hs-var hs-var">dataDeclsBySymbol</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958471"><span class="annot"><span class="annottext">Map Symbol (Id, EffectDeclaration Symbol Ann)
effectDeclsBySymbol :: Map Symbol (Id, EffectDeclaration Symbol Ann)
$sel:effectDeclsBySymbol:FileSummary :: FileSummary -&gt; Map Symbol (Id, EffectDeclaration Symbol Ann)
</span><a href="#local-6989586621680958471"><span class="hs-identifier hs-var hs-var">effectDeclsBySymbol</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Uri -&gt; MaybeT Lsp FileSummary
</span><a href="Unison.LSP.FileAnalysis.html#getFileSummary"><span class="hs-identifier hs-var">getFileSummary</span></a></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958452"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-77"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">((Id, DataDeclaration Symbol Ann) -&gt; MaybeT Lsp TypeReference)
-&gt; Map Symbol (Id, DataDeclaration Symbol Ann)
-&gt; MaybeT Lsp TypeReference
forall (f :: * -&gt; *) (t :: * -&gt; *) a b.
(Alternative f, Foldable t) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f b
</span><span class="hs-identifier hs-var">altMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe TypeReference -&gt; MaybeT Lsp TypeReference
forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958459"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe TypeReference -&gt; MaybeT Lsp TypeReference)
-&gt; ((Id, DataDeclaration Symbol Ann) -&gt; Maybe TypeReference)
-&gt; (Id, DataDeclaration Symbol Ann)
-&gt; MaybeT Lsp TypeReference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Decl Symbol Ann -&gt; Maybe TypeReference
</span><a href="Unison.LSP.Queries.html#refInDecl"><span class="hs-identifier hs-var">refInDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958467"><span class="hs-identifier hs-var">uPos</span></a></span><span> </span><span class="annot"><span class="annottext">(Decl Symbol Ann -&gt; Maybe TypeReference)
-&gt; ((Id, DataDeclaration Symbol Ann) -&gt; Decl Symbol Ann)
-&gt; (Id, DataDeclaration Symbol Ann)
-&gt; Maybe TypeReference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann -&gt; Decl Symbol Ann
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(DataDeclaration Symbol Ann -&gt; Decl Symbol Ann)
-&gt; ((Id, DataDeclaration Symbol Ann) -&gt; DataDeclaration Symbol Ann)
-&gt; (Id, DataDeclaration Symbol Ann)
-&gt; Decl Symbol Ann
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Id, DataDeclaration Symbol Ann) -&gt; DataDeclaration Symbol Ann
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Symbol (Id, DataDeclaration Symbol Ann)
</span><a href="#local-6989586621680958469"><span class="hs-identifier hs-var">dataDeclsBySymbol</span></a></span><span>
</span><span id="line-78"></span><span>            </span><span class="annot"><span class="annottext">MaybeT Lsp TypeReference
-&gt; MaybeT Lsp TypeReference -&gt; MaybeT Lsp TypeReference
forall a. MaybeT Lsp a -&gt; MaybeT Lsp a -&gt; MaybeT Lsp a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Id, EffectDeclaration Symbol Ann) -&gt; MaybeT Lsp TypeReference)
-&gt; Map Symbol (Id, EffectDeclaration Symbol Ann)
-&gt; MaybeT Lsp TypeReference
forall (f :: * -&gt; *) (t :: * -&gt; *) a b.
(Alternative f, Foldable t) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f b
</span><span class="hs-identifier hs-var">altMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe TypeReference -&gt; MaybeT Lsp TypeReference
forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958459"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe TypeReference -&gt; MaybeT Lsp TypeReference)
-&gt; ((Id, EffectDeclaration Symbol Ann) -&gt; Maybe TypeReference)
-&gt; (Id, EffectDeclaration Symbol Ann)
-&gt; MaybeT Lsp TypeReference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Decl Symbol Ann -&gt; Maybe TypeReference
</span><a href="Unison.LSP.Queries.html#refInDecl"><span class="hs-identifier hs-var">refInDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958467"><span class="hs-identifier hs-var">uPos</span></a></span><span> </span><span class="annot"><span class="annottext">(Decl Symbol Ann -&gt; Maybe TypeReference)
-&gt; ((Id, EffectDeclaration Symbol Ann) -&gt; Decl Symbol Ann)
-&gt; (Id, EffectDeclaration Symbol Ann)
-&gt; Maybe TypeReference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EffectDeclaration Symbol Ann -&gt; Decl Symbol Ann
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(EffectDeclaration Symbol Ann -&gt; Decl Symbol Ann)
-&gt; ((Id, EffectDeclaration Symbol Ann)
    -&gt; EffectDeclaration Symbol Ann)
-&gt; (Id, EffectDeclaration Symbol Ann)
-&gt; Decl Symbol Ann
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Id, EffectDeclaration Symbol Ann) -&gt; EffectDeclaration Symbol Ann
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Symbol (Id, EffectDeclaration Symbol Ann)
</span><a href="#local-6989586621680958471"><span class="hs-identifier hs-var">effectDeclsBySymbol</span></a></span><span>
</span><span id="line-79"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621680957897"><span class="annot"><a href="#local-6989586621680958459"><span class="hs-identifier hs-type">hoistMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680957897"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957897"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-81"></span><span>    </span><span id="local-6989586621680958459"><span class="annot"><span class="annottext">hoistMaybe :: forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958459"><span class="hs-identifier hs-var hs-var">hoistMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lsp (Maybe a) -&gt; MaybeT Lsp a
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(Lsp (Maybe a) -&gt; MaybeT Lsp a)
-&gt; (Maybe a -&gt; Lsp (Maybe a)) -&gt; Maybe a -&gt; MaybeT Lsp a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Lsp (Maybe a)
forall a. a -&gt; Lsp a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="annot"><span class="hs-comment">-- | Gets the type of a reference from either the parsed file or the codebase.</span></span><span>
</span><span id="line-84"></span><span class="annot"><a href="Unison.LSP.Queries.html#getTypeOfReferent"><span class="hs-identifier hs-type">getTypeOfReferent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Uri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span id="getTypeOfReferent"><span class="annot"><span class="annottext">getTypeOfReferent :: Uri -&gt; Referent -&gt; MaybeT Lsp (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#getTypeOfReferent"><span class="hs-identifier hs-var hs-var">getTypeOfReferent</span></a></span></span><span> </span><span id="local-6989586621680958478"><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958478"><span class="hs-identifier hs-var">fileUri</span></a></span></span><span> </span><span id="local-6989586621680958479"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680958479"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Lsp (Type Symbol Ann)
</span><a href="#local-6989586621680958480"><span class="hs-identifier hs-var">getFromFile</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp (Type Symbol Ann)
-&gt; MaybeT Lsp (Type Symbol Ann) -&gt; MaybeT Lsp (Type Symbol Ann)
forall a. MaybeT Lsp a -&gt; MaybeT Lsp a -&gt; MaybeT Lsp a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp (Type Symbol Ann)
</span><a href="#local-6989586621680958481"><span class="hs-identifier hs-var">getFromCodebase</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-88"></span><span>    </span><span id="local-6989586621680958480"><span class="annot"><span class="annottext">getFromFile :: MaybeT Lsp (Type Symbol Ann)
</span><a href="#local-6989586621680958480"><span class="hs-identifier hs-var hs-var">getFromFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-89"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">FileSummary</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680958482"><span class="annot"><span class="annottext">Map
  (Maybe Id)
  (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
termsByReference :: Map
  (Maybe Id)
  (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
$sel:termsByReference:FileSummary :: FileSummary
-&gt; Map
     (Maybe Id)
     (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
</span><a href="#local-6989586621680958482"><span class="hs-identifier hs-var hs-var">termsByReference</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Uri -&gt; MaybeT Lsp FileSummary
</span><a href="Unison.LSP.FileAnalysis.html#getFileSummary"><span class="hs-identifier hs-var">getFileSummary</span></a></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958478"><span class="hs-identifier hs-var">fileUri</span></a></span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680958479"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-91"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Referent.Ref</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Builtin</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp (Type Symbol Ann)
forall a. MaybeT Lsp a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-92"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Referent.Ref</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.DerivedId</span></span><span> </span><span id="local-6989586621680958488"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680958488"><span class="hs-identifier hs-var">termRefId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>          </span><span class="annot"><span class="annottext">Lsp (Maybe (Type Symbol Ann)) -&gt; MaybeT Lsp (Type Symbol Ann)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(Lsp (Maybe (Type Symbol Ann)) -&gt; MaybeT Lsp (Type Symbol Ann))
-&gt; (Maybe (Type Symbol Ann) -&gt; Lsp (Maybe (Type Symbol Ann)))
-&gt; Maybe (Type Symbol Ann)
-&gt; MaybeT Lsp (Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann) -&gt; Lsp (Maybe (Type Symbol Ann))
forall a. a -&gt; Lsp a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Type Symbol Ann) -&gt; MaybeT Lsp (Type Symbol Ann))
-&gt; Maybe (Type Symbol Ann) -&gt; MaybeT Lsp (Type Symbol Ann)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map
  (Maybe Id)
  (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
</span><a href="#local-6989586621680958482"><span class="hs-identifier hs-var">termsByReference</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Maybe Id)
  (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
-&gt; Getting
     (First (Type Symbol Ann))
     (Map
        (Maybe Id)
        (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))))
     (Type Symbol Ann)
-&gt; Maybe (Type Symbol Ann)
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">Index
  (Map
     (Maybe Id)
     (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))))
-&gt; Traversal'
     (Map
        (Maybe Id)
        (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))))
     (IxValue
        (Map
           (Maybe Id)
           (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Maybe Id
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680958488"><span class="hs-identifier hs-var">termRefId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
  -&gt; Const
       (First (Type Symbol Ann))
       (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))))
 -&gt; Map
      (Maybe Id)
      (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
 -&gt; Const
      (First (Type Symbol Ann))
      (Map
         (Maybe Id)
         (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))))
-&gt; ((Type Symbol Ann
     -&gt; Const (First (Type Symbol Ann)) (Type Symbol Ann))
    -&gt; Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
    -&gt; Const
         (First (Type Symbol Ann))
         (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))))
-&gt; Getting
     (First (Type Symbol Ann))
     (Map
        (Maybe Id)
        (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))))
     (Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
 -&gt; Const
      (First (Type Symbol Ann))
      (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
-&gt; Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
-&gt; Const
     (First (Type Symbol Ann))
     (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
IndexedFold
  Int
  (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
  (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
</span><span class="hs-identifier hs-var">folded</span></span><span> </span><span class="annot"><span class="annottext">(((Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
  -&gt; Const
       (First (Type Symbol Ann))
       (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
 -&gt; Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
 -&gt; Const
      (First (Type Symbol Ann))
      (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))))
-&gt; ((Type Symbol Ann
     -&gt; Const (First (Type Symbol Ann)) (Type Symbol Ann))
    -&gt; (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
    -&gt; Const
         (First (Type Symbol Ann))
         (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
-&gt; (Type Symbol Ann
    -&gt; Const (First (Type Symbol Ann)) (Type Symbol Ann))
-&gt; Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
-&gt; Const
     (First (Type Symbol Ann))
     (Map Symbol (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Type Symbol Ann)
 -&gt; Const (First (Type Symbol Ann)) (Maybe (Type Symbol Ann)))
-&gt; (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
-&gt; Const
     (First (Type Symbol Ann))
     (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
forall s t a b. Field3 s t a b =&gt; Lens s t a b
Lens
  (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
  (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
  (Maybe (Type Symbol Ann))
  (Maybe (Type Symbol Ann))
</span><span class="hs-identifier hs-var">_3</span></span><span> </span><span class="annot"><span class="annottext">((Maybe (Type Symbol Ann)
  -&gt; Const (First (Type Symbol Ann)) (Maybe (Type Symbol Ann)))
 -&gt; (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
 -&gt; Const
      (First (Type Symbol Ann))
      (Ann, Term Symbol Ann, Maybe (Type Symbol Ann)))
-&gt; ((Type Symbol Ann
     -&gt; Const (First (Type Symbol Ann)) (Type Symbol Ann))
    -&gt; Maybe (Type Symbol Ann)
    -&gt; Const (First (Type Symbol Ann)) (Maybe (Type Symbol Ann)))
-&gt; (Type Symbol Ann
    -&gt; Const (First (Type Symbol Ann)) (Type Symbol Ann))
-&gt; (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
-&gt; Const
     (First (Type Symbol Ann))
     (Ann, Term Symbol Ann, Maybe (Type Symbol Ann))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Type Symbol Ann
 -&gt; Const (First (Type Symbol Ann)) (Type Symbol Ann))
-&gt; Maybe (Type Symbol Ann)
-&gt; Const (First (Type Symbol Ann)) (Maybe (Type Symbol Ann))
forall a b (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p a (f b) -&gt; p (Maybe a) (f (Maybe b))
</span><span class="hs-identifier hs-var">_Just</span></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Referent.Con</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference</span></span><span> </span><span id="local-6989586621680958496"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958496"><span class="hs-identifier hs-var">r0</span></a></span></span><span> </span><span id="local-6989586621680958497"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680958497"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680958498"><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680958498"><span class="hs-identifier hs-var">_type</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-95"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958496"><span class="hs-identifier hs-var">r0</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-96"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Reference.DerivedId</span></span><span> </span><span id="local-6989586621680958499"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680958499"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-97"></span><span>              </span><span id="local-6989586621680958500"><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680958500"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Uri -&gt; Id -&gt; MaybeT Lsp (Decl Symbol Ann)
</span><a href="Unison.LSP.Queries.html#getTypeDeclaration"><span class="hs-identifier hs-var">getTypeDeclaration</span></a></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958478"><span class="hs-identifier hs-var">fileUri</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680958499"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-98"></span><span>              </span><span class="annot"><span class="annottext">Lsp (Maybe (Type Symbol Ann)) -&gt; MaybeT Lsp (Type Symbol Ann)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(Lsp (Maybe (Type Symbol Ann)) -&gt; MaybeT Lsp (Type Symbol Ann))
-&gt; (Maybe (Type Symbol Ann) -&gt; Lsp (Maybe (Type Symbol Ann)))
-&gt; Maybe (Type Symbol Ann)
-&gt; MaybeT Lsp (Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann) -&gt; Lsp (Maybe (Type Symbol Ann))
forall a. a -&gt; Lsp a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Type Symbol Ann) -&gt; MaybeT Lsp (Type Symbol Ann))
-&gt; Maybe (Type Symbol Ann) -&gt; MaybeT Lsp (Type Symbol Ann)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann
-&gt; ConstructorId -&gt; Maybe (Type Symbol Ann)
forall v a.
DataDeclaration v a -&gt; ConstructorId -&gt; Maybe (Type v a)
</span><span class="hs-identifier hs-var">DD.typeOfConstructor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EffectDeclaration Symbol Ann -&gt; DataDeclaration Symbol Ann)
-&gt; (DataDeclaration Symbol Ann -&gt; DataDeclaration Symbol Ann)
-&gt; Decl Symbol Ann
-&gt; DataDeclaration Symbol Ann
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">EffectDeclaration Symbol Ann -&gt; DataDeclaration Symbol Ann
forall v a. EffectDeclaration v a -&gt; DataDeclaration v a
</span><span class="hs-identifier hs-var">DD.toDataDecl</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann -&gt; DataDeclaration Symbol Ann
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680958500"><span class="hs-identifier hs-var">decl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680958497"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-99"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Reference.Builtin</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp (Type Symbol Ann)
forall a. MaybeT Lsp a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-100"></span><span>    </span><span id="local-6989586621680958481"><span class="annot"><span class="annottext">getFromCodebase :: MaybeT Lsp (Type Symbol Ann)
</span><a href="#local-6989586621680958481"><span class="hs-identifier hs-var hs-var">getFromCodebase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680958506"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
codebase :: Codebase IO Symbol Ann
$sel:codebase:Env :: Env -&gt; Codebase IO Symbol Ann
</span><a href="#local-6989586621680958506"><span class="hs-identifier hs-var hs-var">codebase</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp Env
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-102"></span><span>      </span><span class="annot"><span class="annottext">Lsp (Maybe (Type Symbol Ann)) -&gt; MaybeT Lsp (Type Symbol Ann)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(Lsp (Maybe (Type Symbol Ann)) -&gt; MaybeT Lsp (Type Symbol Ann))
-&gt; (IO (Maybe (Type Symbol Ann)) -&gt; Lsp (Maybe (Type Symbol Ann)))
-&gt; IO (Maybe (Type Symbol Ann))
-&gt; MaybeT Lsp (Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO (Maybe (Type Symbol Ann)) -&gt; Lsp (Maybe (Type Symbol Ann))
forall a. IO a -&gt; Lsp a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe (Type Symbol Ann)) -&gt; MaybeT Lsp (Type Symbol Ann))
-&gt; IO (Maybe (Type Symbol Ann)) -&gt; MaybeT Lsp (Type Symbol Ann)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Transaction (Maybe (Type Symbol Ann))
-&gt; IO (Maybe (Type Symbol Ann))
forall (m :: * -&gt; *) v a b.
MonadIO m =&gt;
Codebase m v a -&gt; Transaction b -&gt; m b
</span><span class="hs-identifier hs-var">Codebase.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680958506"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe (Type Symbol Ann))
 -&gt; IO (Maybe (Type Symbol Ann)))
-&gt; Transaction (Maybe (Type Symbol Ann))
-&gt; IO (Maybe (Type Symbol Ann))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Referent -&gt; Transaction (Maybe (Type Symbol Ann))
forall a (m :: * -&gt; *).
BuiltinAnnotation a =&gt;
Codebase m Symbol a
-&gt; Referent -&gt; Transaction (Maybe (Type Symbol a))
</span><span class="hs-identifier hs-var">Codebase.getTypeOfReferent</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680958506"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680958479"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="annot"><span class="hs-comment">-- | Gets a decl from either the parsed file or the codebase.</span></span><span>
</span><span id="line-105"></span><span class="annot"><a href="Unison.LSP.Queries.html#getTypeDeclaration"><span class="hs-identifier hs-type">getTypeDeclaration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Uri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span id="getTypeDeclaration"><span class="annot"><span class="annottext">getTypeDeclaration :: Uri -&gt; Id -&gt; MaybeT Lsp (Decl Symbol Ann)
</span><a href="Unison.LSP.Queries.html#getTypeDeclaration"><span class="hs-identifier hs-var hs-var">getTypeDeclaration</span></a></span></span><span> </span><span id="local-6989586621680958512"><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958512"><span class="hs-identifier hs-var">fileUri</span></a></span></span><span> </span><span id="local-6989586621680958513"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680958513"><span class="hs-identifier hs-var">refId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Lsp (Decl Symbol Ann)
</span><a href="#local-6989586621680958514"><span class="hs-identifier hs-var">getFromFile</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp (Decl Symbol Ann)
-&gt; MaybeT Lsp (Decl Symbol Ann) -&gt; MaybeT Lsp (Decl Symbol Ann)
forall a. MaybeT Lsp a -&gt; MaybeT Lsp a -&gt; MaybeT Lsp a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp (Decl Symbol Ann)
</span><a href="#local-6989586621680958515"><span class="hs-identifier hs-var">getFromCodebase</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><a href="#local-6989586621680958514"><span class="hs-identifier hs-type">getFromFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621680958514"><span class="annot"><span class="annottext">getFromFile :: MaybeT Lsp (Decl Symbol Ann)
</span><a href="#local-6989586621680958514"><span class="hs-identifier hs-var hs-var">getFromFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-111"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">FileSummary</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680958516"><span class="annot"><span class="annottext">Map Id (Map Symbol (DataDeclaration Symbol Ann))
dataDeclsByReference :: Map Id (Map Symbol (DataDeclaration Symbol Ann))
$sel:dataDeclsByReference:FileSummary :: FileSummary -&gt; Map Id (Map Symbol (DataDeclaration Symbol Ann))
</span><a href="#local-6989586621680958516"><span class="hs-identifier hs-var hs-var">dataDeclsByReference</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958518"><span class="annot"><span class="annottext">Map Id (Map Symbol (EffectDeclaration Symbol Ann))
effectDeclsByReference :: Map Id (Map Symbol (EffectDeclaration Symbol Ann))
$sel:effectDeclsByReference:FileSummary :: FileSummary -&gt; Map Id (Map Symbol (EffectDeclaration Symbol Ann))
</span><a href="#local-6989586621680958518"><span class="hs-identifier hs-var hs-var">effectDeclsByReference</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Uri -&gt; MaybeT Lsp FileSummary
</span><a href="Unison.LSP.FileAnalysis.html#getFileSummary"><span class="hs-identifier hs-var">getFileSummary</span></a></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958512"><span class="hs-identifier hs-var">fileUri</span></a></span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958520"><span class="annot"><span class="annottext">datas :: [DataDeclaration Symbol Ann]
</span><a href="#local-6989586621680958520"><span class="hs-identifier hs-var hs-var">datas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Id (Map Symbol (DataDeclaration Symbol Ann))
</span><a href="#local-6989586621680958516"><span class="hs-identifier hs-var">dataDeclsByReference</span></a></span><span> </span><span class="annot"><span class="annottext">Map Id (Map Symbol (DataDeclaration Symbol Ann))
-&gt; Getting
     (Endo [DataDeclaration Symbol Ann])
     (Map Id (Map Symbol (DataDeclaration Symbol Ann)))
     (DataDeclaration Symbol Ann)
-&gt; [DataDeclaration Symbol Ann]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">Index (Map Id (Map Symbol (DataDeclaration Symbol Ann)))
-&gt; Traversal'
     (Map Id (Map Symbol (DataDeclaration Symbol Ann)))
     (IxValue (Map Id (Map Symbol (DataDeclaration Symbol Ann))))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map Id (Map Symbol (DataDeclaration Symbol Ann)))
Id
</span><a href="#local-6989586621680958513"><span class="hs-identifier hs-var">refId</span></a></span><span> </span><span class="annot"><span class="annottext">((Map Symbol (DataDeclaration Symbol Ann)
  -&gt; Const
       (Endo [DataDeclaration Symbol Ann])
       (Map Symbol (DataDeclaration Symbol Ann)))
 -&gt; Map Id (Map Symbol (DataDeclaration Symbol Ann))
 -&gt; Const
      (Endo [DataDeclaration Symbol Ann])
      (Map Id (Map Symbol (DataDeclaration Symbol Ann))))
-&gt; ((DataDeclaration Symbol Ann
     -&gt; Const
          (Endo [DataDeclaration Symbol Ann]) (DataDeclaration Symbol Ann))
    -&gt; Map Symbol (DataDeclaration Symbol Ann)
    -&gt; Const
         (Endo [DataDeclaration Symbol Ann])
         (Map Symbol (DataDeclaration Symbol Ann)))
-&gt; Getting
     (Endo [DataDeclaration Symbol Ann])
     (Map Id (Map Symbol (DataDeclaration Symbol Ann)))
     (DataDeclaration Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(DataDeclaration Symbol Ann
 -&gt; Const
      (Endo [DataDeclaration Symbol Ann]) (DataDeclaration Symbol Ann))
-&gt; Map Symbol (DataDeclaration Symbol Ann)
-&gt; Const
     (Endo [DataDeclaration Symbol Ann])
     (Map Symbol (DataDeclaration Symbol Ann))
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
IndexedFold
  Int
  (Map Symbol (DataDeclaration Symbol Ann))
  (DataDeclaration Symbol Ann)
</span><span class="hs-identifier hs-var">folded</span></span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958522"><span class="annot"><span class="annottext">effects :: [EffectDeclaration Symbol Ann]
</span><a href="#local-6989586621680958522"><span class="hs-identifier hs-var hs-var">effects</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Id (Map Symbol (EffectDeclaration Symbol Ann))
</span><a href="#local-6989586621680958518"><span class="hs-identifier hs-var">effectDeclsByReference</span></a></span><span> </span><span class="annot"><span class="annottext">Map Id (Map Symbol (EffectDeclaration Symbol Ann))
-&gt; Getting
     (Endo [EffectDeclaration Symbol Ann])
     (Map Id (Map Symbol (EffectDeclaration Symbol Ann)))
     (EffectDeclaration Symbol Ann)
-&gt; [EffectDeclaration Symbol Ann]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">Index (Map Id (Map Symbol (EffectDeclaration Symbol Ann)))
-&gt; Traversal'
     (Map Id (Map Symbol (EffectDeclaration Symbol Ann)))
     (IxValue (Map Id (Map Symbol (EffectDeclaration Symbol Ann))))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map Id (Map Symbol (EffectDeclaration Symbol Ann)))
Id
</span><a href="#local-6989586621680958513"><span class="hs-identifier hs-var">refId</span></a></span><span> </span><span class="annot"><span class="annottext">((Map Symbol (EffectDeclaration Symbol Ann)
  -&gt; Const
       (Endo [EffectDeclaration Symbol Ann])
       (Map Symbol (EffectDeclaration Symbol Ann)))
 -&gt; Map Id (Map Symbol (EffectDeclaration Symbol Ann))
 -&gt; Const
      (Endo [EffectDeclaration Symbol Ann])
      (Map Id (Map Symbol (EffectDeclaration Symbol Ann))))
-&gt; ((EffectDeclaration Symbol Ann
     -&gt; Const
          (Endo [EffectDeclaration Symbol Ann])
          (EffectDeclaration Symbol Ann))
    -&gt; Map Symbol (EffectDeclaration Symbol Ann)
    -&gt; Const
         (Endo [EffectDeclaration Symbol Ann])
         (Map Symbol (EffectDeclaration Symbol Ann)))
-&gt; Getting
     (Endo [EffectDeclaration Symbol Ann])
     (Map Id (Map Symbol (EffectDeclaration Symbol Ann)))
     (EffectDeclaration Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(EffectDeclaration Symbol Ann
 -&gt; Const
      (Endo [EffectDeclaration Symbol Ann])
      (EffectDeclaration Symbol Ann))
-&gt; Map Symbol (EffectDeclaration Symbol Ann)
-&gt; Const
     (Endo [EffectDeclaration Symbol Ann])
     (Map Symbol (EffectDeclaration Symbol Ann))
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
IndexedFold
  Int
  (Map Symbol (EffectDeclaration Symbol Ann))
  (EffectDeclaration Symbol Ann)
</span><span class="hs-identifier hs-var">folded</span></span><span>
</span><span id="line-114"></span><span>      </span><span class="annot"><span class="annottext">Lsp (Maybe (Decl Symbol Ann)) -&gt; MaybeT Lsp (Decl Symbol Ann)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(Lsp (Maybe (Decl Symbol Ann)) -&gt; MaybeT Lsp (Decl Symbol Ann))
-&gt; ([Decl Symbol Ann] -&gt; Lsp (Maybe (Decl Symbol Ann)))
-&gt; [Decl Symbol Ann]
-&gt; MaybeT Lsp (Decl Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Decl Symbol Ann) -&gt; Lsp (Maybe (Decl Symbol Ann))
forall a. a -&gt; Lsp a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Decl Symbol Ann) -&gt; Lsp (Maybe (Decl Symbol Ann)))
-&gt; ([Decl Symbol Ann] -&gt; Maybe (Decl Symbol Ann))
-&gt; [Decl Symbol Ann]
-&gt; Lsp (Maybe (Decl Symbol Ann))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Decl Symbol Ann] -&gt; Maybe (Decl Symbol Ann)
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="annot"><span class="annottext">([Decl Symbol Ann] -&gt; MaybeT Lsp (Decl Symbol Ann))
-&gt; [Decl Symbol Ann] -&gt; MaybeT Lsp (Decl Symbol Ann)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DataDeclaration Symbol Ann -&gt; Decl Symbol Ann)
-&gt; [DataDeclaration Symbol Ann] -&gt; [Decl Symbol Ann]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann -&gt; Decl Symbol Ann
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">[DataDeclaration Symbol Ann]
</span><a href="#local-6989586621680958520"><span class="hs-identifier hs-var">datas</span></a></span><span> </span><span class="annot"><span class="annottext">[Decl Symbol Ann] -&gt; [Decl Symbol Ann] -&gt; [Decl Symbol Ann]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(EffectDeclaration Symbol Ann -&gt; Decl Symbol Ann)
-&gt; [EffectDeclaration Symbol Ann] -&gt; [Decl Symbol Ann]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">EffectDeclaration Symbol Ann -&gt; Decl Symbol Ann
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">[EffectDeclaration Symbol Ann]
</span><a href="#local-6989586621680958522"><span class="hs-identifier hs-var">effects</span></a></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621680958515"><span class="annot"><span class="annottext">getFromCodebase :: MaybeT Lsp (Decl Symbol Ann)
</span><a href="#local-6989586621680958515"><span class="hs-identifier hs-var hs-var">getFromCodebase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>      </span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680958524"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
$sel:codebase:Env :: Env -&gt; Codebase IO Symbol Ann
codebase :: Codebase IO Symbol Ann
</span><a href="Unison.LSP.Types.html#%24sel%3Acodebase%3AEnv"><span class="hs-identifier hs-var hs-var">codebase</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp Env
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="annottext">Lsp (Maybe (Decl Symbol Ann)) -&gt; MaybeT Lsp (Decl Symbol Ann)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(Lsp (Maybe (Decl Symbol Ann)) -&gt; MaybeT Lsp (Decl Symbol Ann))
-&gt; (IO (Maybe (Decl Symbol Ann)) -&gt; Lsp (Maybe (Decl Symbol Ann)))
-&gt; IO (Maybe (Decl Symbol Ann))
-&gt; MaybeT Lsp (Decl Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO (Maybe (Decl Symbol Ann)) -&gt; Lsp (Maybe (Decl Symbol Ann))
forall a. IO a -&gt; Lsp a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe (Decl Symbol Ann)) -&gt; MaybeT Lsp (Decl Symbol Ann))
-&gt; IO (Maybe (Decl Symbol Ann)) -&gt; MaybeT Lsp (Decl Symbol Ann)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Transaction (Maybe (Decl Symbol Ann))
-&gt; IO (Maybe (Decl Symbol Ann))
forall (m :: * -&gt; *) v a b.
MonadIO m =&gt;
Codebase m v a -&gt; Transaction b -&gt; m b
</span><span class="hs-identifier hs-var">Codebase.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680958524"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe (Decl Symbol Ann))
 -&gt; IO (Maybe (Decl Symbol Ann)))
-&gt; Transaction (Maybe (Decl Symbol Ann))
-&gt; IO (Maybe (Decl Symbol Ann))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Id -&gt; Transaction (Maybe (Decl Symbol Ann))
forall (m :: * -&gt; *) v a.
Codebase m v a -&gt; Id -&gt; Transaction (Maybe (Decl v a))
</span><span class="hs-identifier hs-var">Codebase.getTypeDeclaration</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680958524"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680958513"><span class="hs-identifier hs-var">refId</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="annot"><span class="hs-comment">-- | Returns the reference a given term node refers to, if any.</span></span><span>
</span><span id="line-121"></span><span id="local-6989586621680957901"><span id="local-6989586621680957902"><span class="annot"><a href="Unison.LSP.Queries.html#refInTerm"><span class="hs-identifier hs-type">refInTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621680957901"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957902"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LabeledDependency</span></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-122"></span><span id="refInTerm"><span class="annot"><span class="annottext">refInTerm :: forall v a. Term v a -&gt; Maybe LabeledDependency
</span><a href="Unison.LSP.Queries.html#refInTerm"><span class="hs-identifier hs-var hs-var">refInTerm</span></a></span></span><span> </span><span id="local-6989586621680958526"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958526"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Term v a -&gt; ABT (F v a a) v (Term v a)
forall (f :: * -&gt; *) v a. Term f v a -&gt; ABT f v (Term f v a)
</span><span class="hs-identifier hs-var">ABT.out</span></span><span> </span><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958526"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ABT.Tm</span></span><span> </span><span id="local-6989586621680958529"><span class="annot"><span class="annottext">F v a a (Term v a)
</span><a href="#local-6989586621680958529"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">F v a a (Term v a)
</span><a href="#local-6989586621680958529"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Int</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-126"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Nat</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Float</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-128"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Boolean</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Text</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-130"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Char</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-131"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Blank</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-132"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Ref</span></span><span> </span><span id="local-6989586621680958538"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958538"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LabeledDependency -&gt; Maybe LabeledDependency
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeReference -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">LD.TermReference</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958538"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Constructor</span></span><span> </span><span id="local-6989586621680958541"><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958541"><span class="hs-identifier hs-var">conRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LabeledDependency -&gt; Maybe LabeledDependency
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GConstructorReference TypeReference
-&gt; ConstructorType -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">LD.ConReference</span></span><span> </span><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958541"><span class="hs-identifier hs-var">conRef</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><span class="hs-identifier hs-var">CT.Data</span></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Request</span></span><span> </span><span id="local-6989586621680958545"><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958545"><span class="hs-identifier hs-var">conRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LabeledDependency -&gt; Maybe LabeledDependency
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GConstructorReference TypeReference
-&gt; ConstructorType -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">LD.ConReference</span></span><span> </span><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958545"><span class="hs-identifier hs-var">conRef</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><span class="hs-identifier hs-var">CT.Effect</span></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Handle</span></span><span> </span><span id="local-6989586621680958548"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958548"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958549"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958549"><span class="hs-identifier hs-var">_b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-136"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.App</span></span><span> </span><span id="local-6989586621680958551"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958551"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958552"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958552"><span class="hs-identifier hs-var">_b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-137"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Ann</span></span><span> </span><span id="local-6989586621680958554"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958554"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958555"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958555"><span class="hs-identifier hs-var">_typ</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-138"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.List</span></span><span> </span><span id="local-6989586621680958557"><span class="annot"><span class="annottext">Seq (Term v a)
</span><a href="#local-6989586621680958557"><span class="hs-identifier hs-var">_xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-139"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.If</span></span><span> </span><span id="local-6989586621680958559"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958559"><span class="hs-identifier hs-var">_cond</span></a></span></span><span> </span><span id="local-6989586621680958560"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958560"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958561"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958561"><span class="hs-identifier hs-var">_b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-140"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.And</span></span><span> </span><span id="local-6989586621680958563"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958563"><span class="hs-identifier hs-var">_l</span></a></span></span><span> </span><span id="local-6989586621680958564"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958564"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Or</span></span><span> </span><span id="local-6989586621680958566"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958566"><span class="hs-identifier hs-var">_l</span></a></span></span><span> </span><span id="local-6989586621680958567"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958567"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Lam</span></span><span> </span><span id="local-6989586621680958569"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958569"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.LetRec</span></span><span> </span><span id="local-6989586621680958571"><span class="annot"><span class="annottext">IsTop
</span><a href="#local-6989586621680958571"><span class="hs-identifier hs-var">_isTop</span></a></span></span><span> </span><span id="local-6989586621680958572"><span class="annot"><span class="annottext">[Term v a]
</span><a href="#local-6989586621680958572"><span class="hs-identifier hs-var">_xs</span></a></span></span><span> </span><span id="local-6989586621680958573"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958573"><span class="hs-identifier hs-var">_y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-144"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Let</span></span><span> </span><span id="local-6989586621680958575"><span class="annot"><span class="annottext">IsTop
</span><a href="#local-6989586621680958575"><span class="hs-identifier hs-var">_isTop</span></a></span></span><span> </span><span id="local-6989586621680958576"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958576"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958577"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958577"><span class="hs-identifier hs-var">_b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-145"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Match</span></span><span> </span><span id="local-6989586621680958579"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958579"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958580"><span class="annot"><span class="annottext">[MatchCase a (Term v a)]
</span><a href="#local-6989586621680958580"><span class="hs-identifier hs-var">_cases</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.TermLink</span></span><span> </span><span id="local-6989586621680958582"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680958582"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LabeledDependency -&gt; Maybe LabeledDependency
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Referent -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">LD.TermReferent</span></span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680958582"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.TypeLink</span></span><span> </span><span id="local-6989586621680958585"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958585"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LabeledDependency -&gt; Maybe LabeledDependency
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeReference -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">LD.TypeReference</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958585"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ABT.Var</span></span><span> </span><span id="local-6989586621680958587"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680958587"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ABT.Cycle</span></span><span> </span><span id="local-6989586621680958589"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958589"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ABT.Abs</span></span><span> </span><span id="local-6989586621680958591"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680958591"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span id="local-6989586621680958592"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680958592"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">-- Returns the reference a given type node refers to, if any.</span><span>
</span><span id="line-153"></span><span id="local-6989586621680957906"><span id="local-6989586621680957907"><span class="annot"><a href="Unison.LSP.Queries.html#refInType"><span class="hs-identifier hs-type">refInType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><a href="#local-6989586621680957906"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957907"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span></span></span><span>
</span><span id="line-154"></span><span id="refInType"><span class="annot"><span class="annottext">refInType :: forall v a. Type v a -&gt; Maybe TypeReference
</span><a href="Unison.LSP.Queries.html#refInType"><span class="hs-identifier hs-var hs-var">refInType</span></a></span></span><span> </span><span id="local-6989586621680958593"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958593"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type v a -&gt; ABT F v (Type v a)
forall (f :: * -&gt; *) v a. Term f v a -&gt; ABT f v (Term f v a)
</span><span class="hs-identifier hs-var">ABT.out</span></span><span> </span><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958593"><span class="hs-identifier hs-var">typ</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ABT.Tm</span></span><span> </span><span id="local-6989586621680958594"><span class="annot"><span class="annottext">F (Type v a)
</span><a href="#local-6989586621680958594"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">F (Type v a)
</span><a href="#local-6989586621680958594"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Type.Ref</span></span><span> </span><span id="local-6989586621680958596"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958596"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Maybe TypeReference
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958596"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Type.Arrow</span></span><span> </span><span id="local-6989586621680958598"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958598"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958599"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958599"><span class="hs-identifier hs-var">_b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Type.Effect</span></span><span> </span><span id="local-6989586621680958601"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958601"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958602"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958602"><span class="hs-identifier hs-var">_b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-159"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Type.App</span></span><span> </span><span id="local-6989586621680958604"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958604"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958605"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958605"><span class="hs-identifier hs-var">_b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Type.Forall</span></span><span> </span><span id="local-6989586621680958607"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958607"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Type.Ann</span></span><span> </span><span id="local-6989586621680958609"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958609"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span id="local-6989586621680958610"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621680958610"><span class="hs-identifier hs-var">_kind</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Type.Effects</span></span><span> </span><span id="local-6989586621680958612"><span class="annot"><span class="annottext">[Type v a]
</span><a href="#local-6989586621680958612"><span class="hs-identifier hs-var">_es</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Type.IntroOuter</span></span><span> </span><span id="local-6989586621680958614"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958614"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-164"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ABT.Var</span></span><span> </span><span id="local-6989586621680958615"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680958615"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ABT.Cycle</span></span><span> </span><span id="local-6989586621680958616"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958616"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ABT.Abs</span></span><span> </span><span id="local-6989586621680958617"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680958617"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span id="local-6989586621680958618"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680958618"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReference
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="hs-comment">-- Returns the reference a given type node refers to, if any.</span><span>
</span><span id="line-169"></span><span id="local-6989586621680957908"><span class="annot"><a href="Unison.LSP.Queries.html#refInPattern"><span class="hs-identifier hs-type">refInPattern</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Pattern</span></span><span> </span><span class="annot"><a href="#local-6989586621680957908"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LabeledDependency</span></span></span><span>
</span><span id="line-170"></span><span id="refInPattern"><span class="annot"><span class="annottext">refInPattern :: forall a. Pattern a -&gt; Maybe LabeledDependency
</span><a href="Unison.LSP.Queries.html#refInPattern"><span class="hs-identifier hs-var hs-var">refInPattern</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Unbound</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Var</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Boolean</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Int</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Nat</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Float</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Text</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Char</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Constructor</span></span><span> </span><span id="local-6989586621680958628"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680958628"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span id="local-6989586621680958629"><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958629"><span class="hs-identifier hs-var">conRef</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Pattern a]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LabeledDependency -&gt; Maybe LabeledDependency
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GConstructorReference TypeReference
-&gt; ConstructorType -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">LD.ConReference</span></span><span> </span><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958629"><span class="hs-identifier hs-var">conRef</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><span class="hs-identifier hs-var">CT.Data</span></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.As</span></span><span> </span><span id="local-6989586621680958631"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680958631"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span id="local-6989586621680958632"><span class="annot"><span class="annottext">Pattern a
</span><a href="#local-6989586621680958632"><span class="hs-identifier hs-var">_pat</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.EffectPure</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.EffectBind</span></span><span> </span><span id="local-6989586621680958635"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680958635"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span id="local-6989586621680958636"><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958636"><span class="hs-identifier hs-var">conRef</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Pattern a]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Pattern a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LabeledDependency -&gt; Maybe LabeledDependency
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GConstructorReference TypeReference
-&gt; ConstructorType -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">LD.ConReference</span></span><span> </span><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958636"><span class="hs-identifier hs-var">conRef</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><span class="hs-identifier hs-var">CT.Effect</span></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.SequenceLiteral</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.SequenceOp</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LabeledDependency
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-keyword">data</span><span> </span><span id="SourceNode"><span class="annot"><a href="Unison.LSP.Queries.html#SourceNode"><span class="hs-identifier hs-var">SourceNode</span></a></span></span><span> </span><span id="local-6989586621680958013"><span class="annot"><a href="#local-6989586621680958013"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TermNode"><span class="annot"><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="#local-6989586621680958013"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TypeNode"><span class="annot"><a href="Unison.LSP.Queries.html#TypeNode"><span class="hs-identifier hs-var">TypeNode</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="#local-6989586621680958013"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PatternNode"><span class="annot"><a href="Unison.LSP.Queries.html#PatternNode"><span class="hs-identifier hs-var">PatternNode</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Pattern</span></span><span> </span><span class="annot"><a href="#local-6989586621680958013"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680958641"><span id="local-6989586621680958653"><span class="annot"><span class="annottext">SourceNode a -&gt; SourceNode a -&gt; IsTop
(SourceNode a -&gt; SourceNode a -&gt; IsTop)
-&gt; (SourceNode a -&gt; SourceNode a -&gt; IsTop) -&gt; Eq (SourceNode a)
forall a. Eq a =&gt; SourceNode a -&gt; SourceNode a -&gt; IsTop
forall a. (a -&gt; a -&gt; IsTop) -&gt; (a -&gt; a -&gt; IsTop) -&gt; Eq a
$c== :: forall a. Eq a =&gt; SourceNode a -&gt; SourceNode a -&gt; IsTop
== :: SourceNode a -&gt; SourceNode a -&gt; IsTop
$c/= :: forall a. Eq a =&gt; SourceNode a -&gt; SourceNode a -&gt; IsTop
/= :: SourceNode a -&gt; SourceNode a -&gt; IsTop
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958660"><span id="local-6989586621680958674"><span id="local-6989586621680958678"><span class="annot"><span class="annottext">Int -&gt; SourceNode a -&gt; ShowS
[SourceNode a] -&gt; ShowS
SourceNode a -&gt; WatchKind
(Int -&gt; SourceNode a -&gt; ShowS)
-&gt; (SourceNode a -&gt; WatchKind)
-&gt; ([SourceNode a] -&gt; ShowS)
-&gt; Show (SourceNode a)
forall a. Int -&gt; SourceNode a -&gt; ShowS
forall a. [SourceNode a] -&gt; ShowS
forall a. SourceNode a -&gt; WatchKind
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; WatchKind) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall a. Int -&gt; SourceNode a -&gt; ShowS
showsPrec :: Int -&gt; SourceNode a -&gt; ShowS
$cshow :: forall a. SourceNode a -&gt; WatchKind
show :: SourceNode a -&gt; WatchKind
$cshowList :: forall a. [SourceNode a] -&gt; ShowS
showList :: [SourceNode a] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680958684"><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="Unison.LSP.Queries.html#SourceNode"><span class="hs-identifier hs-type">SourceNode</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-193"></span><span>  </span><span id="local-6989586621680958694"><span class="annot"><span class="annottext">fmap :: forall a b. (a -&gt; b) -&gt; SourceNode a -&gt; SourceNode b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fmap</span></span></span><span> </span><span id="local-6989586621680958695"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621680958695"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-type">TermNode</span></a></span><span> </span><span id="local-6989586621680958696"><span class="annot"><span class="annottext">Term Symbol a
</span><a href="#local-6989586621680958696"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term Symbol b -&gt; SourceNode b
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; b) -&gt; Term Symbol a -&gt; Term Symbol b
forall v a a2. Ord v =&gt; (a -&gt; a2) -&gt; Term v a -&gt; Term v a2
</span><span class="hs-identifier hs-var">Term.amap</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621680958695"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol a
</span><a href="#local-6989586621680958696"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">fmap</span></span><span> </span><span id="local-6989586621680958698"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621680958698"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Queries.html#TypeNode"><span class="hs-identifier hs-type">TypeNode</span></a></span><span> </span><span id="local-6989586621680958699"><span class="annot"><span class="annottext">Type Symbol a
</span><a href="#local-6989586621680958699"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type Symbol b -&gt; SourceNode b
forall a. Type Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TypeNode"><span class="hs-identifier hs-var">TypeNode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; b) -&gt; Type Symbol a -&gt; Type Symbol b
forall a b. (a -&gt; b) -&gt; Term F Symbol a -&gt; Term F Symbol b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621680958698"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol a
</span><a href="#local-6989586621680958699"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">fmap</span></span><span> </span><span id="local-6989586621680958700"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621680958700"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Queries.html#PatternNode"><span class="hs-identifier hs-type">PatternNode</span></a></span><span> </span><span id="local-6989586621680958701"><span class="annot"><span class="annottext">Pattern a
</span><a href="#local-6989586621680958701"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pattern b -&gt; SourceNode b
forall a. Pattern a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#PatternNode"><span class="hs-identifier hs-var">PatternNode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; b) -&gt; Pattern a -&gt; Pattern b
forall a b. (a -&gt; b) -&gt; Pattern a -&gt; Pattern b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621680958700"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern a
</span><a href="#local-6989586621680958701"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="hs-comment">-- | Find the node in a term which contains the specified position, but none of its</span><span>
</span><span id="line-198"></span><span class="hs-comment">-- children contain that position.</span><span>
</span><span id="line-199"></span><span class="annot"><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-type">findSmallestEnclosingNode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pos</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Queries.html#SourceNode"><span class="hs-identifier hs-type">SourceNode</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span id="findSmallestEnclosingNode"><span class="annot"><span class="annottext">findSmallestEnclosingNode :: Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var hs-var">findSmallestEnclosingNode</span></a></span></span><span> </span><span id="local-6989586621680958702"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621680958703"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958705"><span class="hs-identifier hs-var">ann</span></a></span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; IsTop -&gt; IsTop
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; IsTop
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958705"><span class="hs-identifier hs-var">ann</span></a></span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Pos -&gt; IsTop
</span><span class="hs-operator hs-var">`Ann.contains`</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680958709"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958709"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Maybe (Term Symbol Ann)
</span><a href="#local-6989586621680958710"><span class="hs-identifier hs-var">cleanImplicitUnit</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958709"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IsTop
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-comment">-- For leaf nodes we require that they be an in-file position, not Intrinsic or</span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-comment">-- external.</span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-comment">-- In some rare cases it's possible for an External/Intrinsic node to have children that</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-comment">-- ARE in the file, so we need to make sure we still crawl their children.</span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958711"><span class="annot"><span class="annottext">guardInFile :: Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var hs-var">guardInFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; IsTop -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958705"><span class="hs-identifier hs-var">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958712"><span class="annot"><span class="annottext">bestChild :: Maybe (SourceNode Ann)
</span><a href="#local-6989586621680958712"><span class="hs-identifier hs-var hs-var">bestChild</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; ABT (F Symbol Ann Ann) Symbol (Term Symbol Ann)
forall (f :: * -&gt; *) v a. Term f v a -&gt; ABT f v (Term f v a)
</span><span class="hs-identifier hs-var">ABT.out</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-210"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">ABT.Tm</span></span><span> </span><span id="local-6989586621680958713"><span class="annot"><span class="annottext">F Symbol Ann Ann (Term Symbol Ann)
</span><a href="#local-6989586621680958713"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">F Symbol Ann Ann (Term Symbol Ann)
</span><a href="#local-6989586621680958713"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-211"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Int</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Nat</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Float</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Boolean</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Text</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Char</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Blank</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Ref</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Constructor</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Request</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Handle</span></span><span> </span><span id="local-6989586621680958714"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958714"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680958715"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958715"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958714"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958715"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-222"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.App</span></span><span> </span><span id="local-6989586621680958716"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958716"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680958717"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958717"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-223"></span><span>                </span><span class="hs-comment">-- We crawl the body of the App first because the annotations for certain</span><span>
</span><span id="line-224"></span><span>                </span><span class="hs-comment">-- lambda syntaxes get a bit squirrelly.</span><span>
</span><span id="line-225"></span><span>                </span><span class="hs-comment">-- Specifically Tuple constructor apps will have an annotation which spans the</span><span>
</span><span id="line-226"></span><span>                </span><span class="hs-comment">-- whole tuple, e.g. the annotation of the tuple constructor for `(1, 2)` will</span><span>
</span><span id="line-227"></span><span>                </span><span class="hs-comment">-- cover ALL of `(1, 2)`, so we check the body of the tuple app first to see</span><span>
</span><span id="line-228"></span><span>                </span><span class="hs-comment">-- if the cursor is on 1 or 2 before falling back on the annotation of the</span><span>
</span><span id="line-229"></span><span>                </span><span class="hs-comment">-- 'function' of the app.</span><span>
</span><span id="line-230"></span><span>                </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958717"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958716"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-231"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Ann</span></span><span> </span><span id="local-6989586621680958718"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958718"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680958719"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958719"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958718"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; SourceNode Ann
forall a. Type Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TypeNode"><span class="hs-identifier hs-var">TypeNode</span></a></span><span> </span><span class="annot"><span class="annottext">(Type Symbol Ann -&gt; SourceNode Ann)
-&gt; Maybe (Type Symbol Ann) -&gt; Maybe (SourceNode Ann)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958719"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.List</span></span><span> </span><span id="local-6989586621680958720"><span class="annot"><span class="annottext">Seq (Term Symbol Ann)
</span><a href="#local-6989586621680958720"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Seq (Maybe (SourceNode Ann)) -&gt; Maybe (SourceNode Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a.
(Alternative f, Foldable t) =&gt;
t (f a) -&gt; f a
</span><span class="hs-identifier hs-var">altSum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann -&gt; Maybe (SourceNode Ann))
-&gt; Seq (Term Symbol Ann) -&gt; Seq (Maybe (SourceNode Ann))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Seq (Term Symbol Ann)
</span><a href="#local-6989586621680958720"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.If</span></span><span> </span><span id="local-6989586621680958722"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958722"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621680958723"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958723"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680958724"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958724"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958722"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958723"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958724"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-234"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.And</span></span><span> </span><span id="local-6989586621680958725"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958725"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621680958726"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958726"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958725"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958726"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-235"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Or</span></span><span> </span><span id="local-6989586621680958727"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958727"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621680958728"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958728"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958727"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958728"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-236"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Lam</span></span><span> </span><span id="local-6989586621680958729"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958729"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958729"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-237"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.LetRec</span></span><span> </span><span id="local-6989586621680958730"><span class="annot"><span class="annottext">IsTop
</span><a href="#local-6989586621680958730"><span class="hs-identifier hs-var">_isTop</span></a></span></span><span> </span><span id="local-6989586621680958731"><span class="annot"><span class="annottext">[Term Symbol Ann]
</span><a href="#local-6989586621680958731"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621680958732"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958732"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Maybe (SourceNode Ann)] -&gt; Maybe (SourceNode Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a.
(Alternative f, Foldable t) =&gt;
t (f a) -&gt; f a
</span><span class="hs-identifier hs-var">altSum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann -&gt; Maybe (SourceNode Ann))
-&gt; [Term Symbol Ann] -&gt; [Maybe (SourceNode Ann)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Term Symbol Ann]
</span><a href="#local-6989586621680958731"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958732"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-238"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Let</span></span><span> </span><span id="local-6989586621680958733"><span class="annot"><span class="annottext">IsTop
</span><a href="#local-6989586621680958733"><span class="hs-identifier hs-var">_isTop</span></a></span></span><span> </span><span id="local-6989586621680958734"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958734"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680958735"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958735"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958734"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958735"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-239"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.Match</span></span><span> </span><span id="local-6989586621680958736"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958736"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680958737"><span class="annot"><span class="annottext">[MatchCase Ann (Term Symbol Ann)]
</span><a href="#local-6989586621680958737"><span class="hs-identifier hs-var">cases</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>                </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958736"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-241"></span><span>                  </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (SourceNode Ann)] -&gt; Maybe (SourceNode Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a.
(Alternative f, Foldable t) =&gt;
t (f a) -&gt; f a
</span><span class="hs-identifier hs-var">altSum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MatchCase Ann (Term Symbol Ann)]
</span><a href="#local-6989586621680958737"><span class="hs-identifier hs-var">cases</span></a></span><span> </span><span class="annot"><span class="annottext">[MatchCase Ann (Term Symbol Ann)]
-&gt; (MatchCase Ann (Term Symbol Ann) -&gt; Maybe (SourceNode Ann))
-&gt; [Maybe (SourceNode Ann)]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MatchCase</span></span><span> </span><span id="local-6989586621680958739"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958739"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621680958740"><span class="annot"><span class="annottext">Maybe (Term Symbol Ann)
</span><a href="#local-6989586621680958740"><span class="hs-identifier hs-var">grd</span></a></span></span><span> </span><span id="local-6989586621680958741"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958741"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pattern Ann -&gt; SourceNode Ann
forall a. Pattern a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#PatternNode"><span class="hs-identifier hs-var">PatternNode</span></a></span><span> </span><span class="annot"><span class="annottext">(Pattern Ann -&gt; SourceNode Ann)
-&gt; Maybe (Pattern Ann) -&gt; Maybe (SourceNode Ann)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958739"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Term Symbol Ann)
</span><a href="#local-6989586621680958740"><span class="hs-identifier hs-var">grd</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Term Symbol Ann)
-&gt; (Term Symbol Ann -&gt; Maybe (SourceNode Ann))
-&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958741"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.TermLink</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Term.TypeLink</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">ABT.Var</span></span><span> </span><span id="local-6989586621680958743"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680958743"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958711"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">ABT.Cycle</span></span><span> </span><span id="local-6989586621680958744"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958744"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958744"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-246"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">ABT.Abs</span></span><span> </span><span id="local-6989586621680958745"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680958745"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span id="local-6989586621680958746"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958746"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958702"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958746"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-247"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958747"><span class="annot"><span class="annottext">fallback :: Maybe (SourceNode Ann)
</span><a href="#local-6989586621680958747"><span class="hs-identifier hs-var hs-var">fallback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958705"><span class="hs-identifier hs-var">ann</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SourceNode Ann -&gt; Maybe (SourceNode Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; SourceNode Ann
forall a. Term Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TermNode"><span class="hs-identifier hs-var">TermNode</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-248"></span><span>      </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
</span><a href="#local-6989586621680958712"><span class="hs-identifier hs-var">bestChild</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
-&gt; Maybe (SourceNode Ann) -&gt; Maybe (SourceNode Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceNode Ann)
</span><a href="#local-6989586621680958747"><span class="hs-identifier hs-var">fallback</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-comment">-- tuples always end in an implicit unit, but it's annotated with the span of the whole</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- tuple, which is problematic, so we need to detect and remove implicit tuples.</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-comment">-- We can detect them because we know that the last element of a tuple is always its</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-comment">-- implicit unit.</span><span>
</span><span id="line-254"></span><span>    </span><span class="annot"><a href="#local-6989586621680958710"><span class="hs-identifier hs-type">cleanImplicitUnit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621680958710"><span class="annot"><span class="annottext">cleanImplicitUnit :: Term Symbol Ann -&gt; Maybe (Term Symbol Ann)
</span><a href="#local-6989586621680958710"><span class="hs-identifier hs-var hs-var">cleanImplicitUnit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-256"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ABT.Tm'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.App</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ABT.Tm'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.App</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ABT.Tm'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.Constructor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference</span></span><span> </span><span id="local-6989586621680958749"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958749"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621680958750"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958750"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621680958751"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958751"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958749"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference -&gt; IsTop
forall a. Eq a =&gt; a -&gt; a -&gt; IsTop
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><span class="hs-identifier hs-var">Builtins.pairRef</span></span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; IsTop -&gt; IsTop
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Ann -&gt; ()) -&gt; Term Symbol Ann -&gt; Term Symbol ()
forall v a a2. Ord v =&gt; (a -&gt; a2) -&gt; Term v a -&gt; Term v a2
</span><span class="hs-identifier hs-var">Term.amap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; Ann -&gt; ()
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958751"><span class="hs-identifier hs-var">trm</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol () -&gt; Term Symbol () -&gt; IsTop
forall a. Eq a =&gt; a -&gt; a -&gt; IsTop
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Term Symbol ()
forall v a vt at ap. Var v =&gt; a -&gt; Term2 vt at ap v a
</span><span class="hs-identifier hs-var">Builtins.unitTerm</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Maybe (Term Symbol Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958750"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-258"></span><span>      </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Term Symbol Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621680958705"><span class="annot"><span class="annottext">ann :: Ann
</span><a href="#local-6989586621680958705"><span class="hs-identifier hs-var hs-var">ann</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Ann
</span><a href="Unison.LSP.Queries.html#getTermSpanAnn"><span class="hs-identifier hs-var">getTermSpanAnn</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958703"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="annot"><span class="hs-comment">-- | Most nodes have the property that their annotation spans all their children, but there are some exceptions.</span></span><span>
</span><span id="line-262"></span><span class="annot"><a href="Unison.LSP.Queries.html#getTermSpanAnn"><span class="hs-identifier hs-type">getTermSpanAnn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span>
</span><span id="line-263"></span><span id="getTermSpanAnn"><span class="annot"><span class="annottext">getTermSpanAnn :: Term Symbol Ann -&gt; Ann
</span><a href="Unison.LSP.Queries.html#getTermSpanAnn"><span class="hs-identifier hs-var hs-var">getTermSpanAnn</span></a></span></span><span> </span><span id="local-6989586621680958756"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958756"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; ABT (F Symbol Ann Ann) Symbol (Term Symbol Ann)
forall (f :: * -&gt; *) v a. Term f v a -&gt; ABT f v (Term f v a)
</span><span class="hs-identifier hs-var">ABT.out</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958756"><span class="hs-identifier hs-var">tm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ABT.Abs</span></span><span> </span><span id="local-6989586621680958757"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680958757"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span id="local-6989586621680958758"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958758"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Ann
forall (f :: * -&gt; *) v a. Term f v a -&gt; a
</span><span class="hs-identifier hs-var">ABT.annotation</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958756"><span class="hs-identifier hs-var">tm</span></a></span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Ann -&gt; Ann
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Ann
</span><a href="Unison.LSP.Queries.html#getTermSpanAnn"><span class="hs-identifier hs-var">getTermSpanAnn</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958758"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><span class="annottext">ABT (F Symbol Ann Ann) Symbol (Term Symbol Ann)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Ann
forall (f :: * -&gt; *) v a. Term f v a -&gt; a
</span><span class="hs-identifier hs-var">ABT.annotation</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958756"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="annot"><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-type">findSmallestEnclosingPattern</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pos</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Pattern</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Pattern</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span id="findSmallestEnclosingPattern"><span class="annot"><span class="annottext">findSmallestEnclosingPattern :: Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var hs-var">findSmallestEnclosingPattern</span></a></span></span><span> </span><span id="local-6989586621680958760"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621680958761"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span></span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680958762"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958762"><span class="hs-identifier hs-var">validTargets</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="#local-6989586621680958763"><span class="hs-identifier hs-var">cleanImplicitUnit</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958762"><span class="hs-identifier hs-var">validTargets</span></a></span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pattern Ann -&gt; Ann
forall a. Annotated a =&gt; a -&gt; Ann
</span><span class="hs-identifier hs-var">ann</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; IsTop -&gt; IsTop
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; IsTop
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pattern Ann -&gt; Ann
forall a. Annotated a =&gt; a -&gt; Ann
</span><span class="hs-identifier hs-var">ann</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Pos -&gt; IsTop
</span><span class="hs-operator hs-var">`Ann.contains`</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Pattern Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IsTop
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-272"></span><span>      </span><span class="hs-comment">-- For leaf nodes we require that they be an in-file position, not Intrinsic or</span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-comment">-- external.</span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-comment">-- In some rare cases it's possible for an External/Intrinsic node to have children that</span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-comment">-- ARE in the file, so we need to make sure we still crawl their children.</span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958764"><span class="annot"><span class="annottext">guardInFile :: Maybe ()
</span><a href="#local-6989586621680958764"><span class="hs-identifier hs-var hs-var">guardInFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; IsTop -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pattern Ann -&gt; Ann
forall a. Annotated a =&gt; a -&gt; Ann
</span><span class="hs-identifier hs-var">ann</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958765"><span class="annot"><span class="annottext">bestChild :: Maybe (Pattern Ann)
</span><a href="#local-6989586621680958765"><span class="hs-identifier hs-var hs-var">bestChild</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-278"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Unbound</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958764"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-279"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Var</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958764"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-280"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Boolean</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958764"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-281"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Int</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958764"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-282"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Nat</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958764"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-283"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Float</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958764"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-284"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Text</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958764"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-285"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Char</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958764"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-286"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Constructor</span></span><span> </span><span id="local-6989586621680958766"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958766"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span id="local-6989586621680958767"><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958767"><span class="hs-identifier hs-var">_conRef</span></a></span></span><span> </span><span id="local-6989586621680958768"><span class="annot"><span class="annottext">[Pattern Ann]
</span><a href="#local-6989586621680958768"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Maybe (Pattern Ann)] -&gt; Maybe (Pattern Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a.
(Alternative f, Foldable t) =&gt;
t (f a) -&gt; f a
</span><span class="hs-identifier hs-var">altSum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">(Pattern Ann -&gt; Maybe (Pattern Ann))
-&gt; [Pattern Ann] -&gt; [Maybe (Pattern Ann)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Pattern Ann]
</span><a href="#local-6989586621680958768"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.As</span></span><span> </span><span id="local-6989586621680958769"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958769"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span id="local-6989586621680958770"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958770"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958770"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-288"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.EffectPure</span></span><span> </span><span id="local-6989586621680958771"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958771"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span id="local-6989586621680958772"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958772"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958772"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-289"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.EffectBind</span></span><span> </span><span id="local-6989586621680958773"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958773"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span id="local-6989586621680958774"><span class="annot"><span class="annottext">GConstructorReference TypeReference
</span><a href="#local-6989586621680958774"><span class="hs-identifier hs-var">_conRef</span></a></span></span><span> </span><span id="local-6989586621680958775"><span class="annot"><span class="annottext">[Pattern Ann]
</span><a href="#local-6989586621680958775"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621680958776"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958776"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Maybe (Pattern Ann)] -&gt; Maybe (Pattern Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a.
(Alternative f, Foldable t) =&gt;
t (f a) -&gt; f a
</span><span class="hs-identifier hs-var">altSum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">(Pattern Ann -&gt; Maybe (Pattern Ann))
-&gt; [Pattern Ann] -&gt; [Maybe (Pattern Ann)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Pattern Ann]
</span><a href="#local-6989586621680958775"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958776"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-290"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.SequenceLiteral</span></span><span> </span><span id="local-6989586621680958777"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958777"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span id="local-6989586621680958778"><span class="annot"><span class="annottext">[Pattern Ann]
</span><a href="#local-6989586621680958778"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Maybe (Pattern Ann)] -&gt; Maybe (Pattern Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a.
(Alternative f, Foldable t) =&gt;
t (f a) -&gt; f a
</span><span class="hs-identifier hs-var">altSum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">(Pattern Ann -&gt; Maybe (Pattern Ann))
-&gt; [Pattern Ann] -&gt; [Maybe (Pattern Ann)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Pattern Ann]
</span><a href="#local-6989586621680958778"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Pattern.SequenceOp</span></span><span> </span><span id="local-6989586621680958779"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958779"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span id="local-6989586621680958780"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958780"><span class="hs-identifier hs-var">p1</span></a></span></span><span> </span><span id="local-6989586621680958781"><span class="annot"><span class="annottext">SeqOp
</span><a href="#local-6989586621680958781"><span class="hs-identifier hs-var">_op</span></a></span></span><span> </span><span id="local-6989586621680958782"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958782"><span class="hs-identifier hs-var">p2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958780"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingPattern"><span class="hs-identifier hs-var">findSmallestEnclosingPattern</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958760"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958782"><span class="hs-identifier hs-var">p2</span></a></span><span>
</span><span id="line-292"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958783"><span class="annot"><span class="annottext">fallback :: Maybe (Pattern Ann)
</span><a href="#local-6989586621680958783"><span class="hs-identifier hs-var hs-var">fallback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pattern Ann -&gt; Ann
forall a. Annotated a =&gt; a -&gt; Ann
</span><span class="hs-identifier hs-var">ann</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958761"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (Pattern Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-293"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Pattern Ann)
</span><a href="#local-6989586621680958765"><span class="hs-identifier hs-var">bestChild</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann) -&gt; Maybe (Pattern Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Pattern Ann)
</span><a href="#local-6989586621680958783"><span class="hs-identifier hs-var">fallback</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-comment">-- tuple patterns always end in an implicit unit, but it's annotated with the span of the whole</span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-comment">-- tuple, which is problematic, so we need to detect and remove implicit tuples.</span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-comment">-- We can detect them because we know that the last element of a tuple is always its</span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-comment">-- implicit unit.</span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><a href="#local-6989586621680958763"><span class="hs-identifier hs-type">cleanImplicitUnit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Pattern</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Pattern</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621680958763"><span class="annot"><span class="annottext">cleanImplicitUnit :: Pattern Ann -&gt; Maybe (Pattern Ann)
</span><a href="#local-6989586621680958763"><span class="hs-identifier hs-var hs-var">cleanImplicitUnit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-301"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Constructor</span></span><span> </span><span id="local-6989586621680958784"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958784"><span class="hs-identifier hs-var">_loc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference</span></span><span> </span><span id="local-6989586621680958785"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958785"><span class="hs-identifier hs-var">conRef</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span id="local-6989586621680958786"><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958786"><span class="hs-identifier hs-var">pat1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pattern.Constructor</span></span><span> </span><span class="annot"><span class="annottext">Ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference</span></span><span> </span><span id="local-6989586621680958787"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958787"><span class="hs-identifier hs-var">mayUnitRef</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Pattern Ann]
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958785"><span class="hs-identifier hs-var">conRef</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference -&gt; IsTop
forall a. Eq a =&gt; a -&gt; a -&gt; IsTop
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><span class="hs-identifier hs-var">Builtins.pairRef</span></span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; IsTop -&gt; IsTop
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958787"><span class="hs-identifier hs-var">mayUnitRef</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference -&gt; IsTop
forall a. Eq a =&gt; a -&gt; a -&gt; IsTop
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><span class="hs-identifier hs-var">Builtins.unitRef</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pattern Ann -&gt; Maybe (Pattern Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Pattern Ann
</span><a href="#local-6989586621680958786"><span class="hs-identifier hs-var">pat1</span></a></span><span>
</span><span id="line-303"></span><span>      </span><span class="annot"><span class="annottext">Pattern Ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Pattern Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="hs-comment">-- | Find the node in a type which contains the specified position, but none of its</span><span>
</span><span id="line-306"></span><span class="hs-comment">-- children contain that position.</span><span>
</span><span id="line-307"></span><span class="hs-comment">-- This is helpful for finding the specific type reference of a given argument within a type arrow</span><span>
</span><span id="line-308"></span><span class="hs-comment">-- that a position references.</span><span>
</span><span id="line-309"></span><span class="annot"><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-type">findSmallestEnclosingType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pos</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span id="findSmallestEnclosingType"><span class="annot"><span class="annottext">findSmallestEnclosingType :: Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var hs-var">findSmallestEnclosingType</span></a></span></span><span> </span><span id="local-6989586621680958789"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621680958790"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958790"><span class="hs-identifier hs-var">typ</span></a></span></span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Ann
forall (f :: * -&gt; *) v a. Term f v a -&gt; a
</span><span class="hs-identifier hs-var">ABT.annotation</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958790"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; IsTop -&gt; IsTop
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; IsTop
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Ann
forall (f :: * -&gt; *) v a. Term f v a -&gt; a
</span><span class="hs-identifier hs-var">ABT.annotation</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958790"><span class="hs-identifier hs-var">typ</span></a></span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Pos -&gt; IsTop
</span><span class="hs-operator hs-var">`Ann.contains`</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IsTop
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>      </span><span class="hs-comment">-- For leaf nodes we require that they be an in-file position, not Intrinsic or</span><span>
</span><span id="line-314"></span><span>      </span><span class="hs-comment">-- external.</span><span>
</span><span id="line-315"></span><span>      </span><span class="hs-comment">-- In some rare cases it's possible for an External/Intrinsic node to have children that</span><span>
</span><span id="line-316"></span><span>      </span><span class="hs-comment">-- ARE in the file, so we need to make sure we still crawl their children.</span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958791"><span class="annot"><span class="annottext">guardInFile :: Maybe ()
</span><a href="#local-6989586621680958791"><span class="hs-identifier hs-var hs-var">guardInFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsTop -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; IsTop -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Ann
forall (f :: * -&gt; *) v a. Term f v a -&gt; a
</span><span class="hs-identifier hs-var">ABT.annotation</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958790"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958792"><span class="annot"><span class="annottext">bestChild :: Maybe (Type Symbol Ann)
</span><a href="#local-6989586621680958792"><span class="hs-identifier hs-var hs-var">bestChild</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; ABT F Symbol (Type Symbol Ann)
forall (f :: * -&gt; *) v a. Term f v a -&gt; ABT f v (Term f v a)
</span><span class="hs-identifier hs-var">ABT.out</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958790"><span class="hs-identifier hs-var">typ</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-319"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">ABT.Tm</span></span><span> </span><span id="local-6989586621680958793"><span class="annot"><span class="annottext">F (Type Symbol Ann)
</span><a href="#local-6989586621680958793"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">F (Type Symbol Ann)
</span><a href="#local-6989586621680958793"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-320"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Type.Ref</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958791"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Type Symbol Ann) -&gt; Maybe (Type Symbol Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958790"><span class="hs-identifier hs-var">typ</span></a></span><span>
</span><span id="line-321"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Type.Arrow</span></span><span> </span><span id="local-6989586621680958794"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958794"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680958795"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958795"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958794"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
-&gt; Maybe (Type Symbol Ann) -&gt; Maybe (Type Symbol Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958795"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-322"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Type.Effect</span></span><span> </span><span id="local-6989586621680958796"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958796"><span class="hs-identifier hs-var">effs</span></a></span></span><span> </span><span id="local-6989586621680958797"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958797"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-323"></span><span>                </span><span class="hs-comment">-- There's currently a bug in the annotations for effects which cause them to</span><span>
</span><span id="line-324"></span><span>                </span><span class="hs-comment">-- span larger than they should. As  a workaround for now we just make sure to</span><span>
</span><span id="line-325"></span><span>                </span><span class="hs-comment">-- search the RHS before the effects.</span><span>
</span><span id="line-326"></span><span>                </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958797"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
-&gt; Maybe (Type Symbol Ann) -&gt; Maybe (Type Symbol Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958796"><span class="hs-identifier hs-var">effs</span></a></span><span>
</span><span id="line-327"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Type.App</span></span><span> </span><span id="local-6989586621680958798"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958798"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680958799"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958799"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958798"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
-&gt; Maybe (Type Symbol Ann) -&gt; Maybe (Type Symbol Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958799"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-328"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Type.Forall</span></span><span> </span><span id="local-6989586621680958800"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958800"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958800"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-329"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Type.Ann</span></span><span> </span><span id="local-6989586621680958801"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958801"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680958802"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621680958802"><span class="hs-identifier hs-var">_kind</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958801"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-330"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Type.Effects</span></span><span> </span><span id="local-6989586621680958803"><span class="annot"><span class="annottext">[Type Symbol Ann]
</span><a href="#local-6989586621680958803"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Maybe (Type Symbol Ann)] -&gt; Maybe (Type Symbol Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a.
(Alternative f, Foldable t) =&gt;
t (f a) -&gt; f a
</span><span class="hs-identifier hs-var">altSum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">(Type Symbol Ann -&gt; Maybe (Type Symbol Ann))
-&gt; [Type Symbol Ann] -&gt; [Maybe (Type Symbol Ann)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Type Symbol Ann]
</span><a href="#local-6989586621680958803"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Type.IntroOuter</span></span><span> </span><span id="local-6989586621680958804"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958804"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958804"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-332"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">ABT.Var</span></span><span> </span><span id="local-6989586621680958805"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680958805"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
</span><a href="#local-6989586621680958791"><span class="hs-identifier hs-var">guardInFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe (Type Symbol Ann) -&gt; Maybe (Type Symbol Ann)
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958790"><span class="hs-identifier hs-var">typ</span></a></span><span>
</span><span id="line-333"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">ABT.Cycle</span></span><span> </span><span id="local-6989586621680958806"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958806"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958806"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-334"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">ABT.Abs</span></span><span> </span><span id="local-6989586621680958807"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680958807"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span id="local-6989586621680958808"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958808"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958789"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958808"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-335"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680958809"><span class="annot"><span class="annottext">fallback :: Maybe (Type Symbol Ann)
</span><a href="#local-6989586621680958809"><span class="hs-identifier hs-var hs-var">fallback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Ann
forall (f :: * -&gt; *) v a. Term f v a -&gt; a
</span><span class="hs-identifier hs-var">ABT.annotation</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958790"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958790"><span class="hs-identifier hs-var">typ</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-336"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
</span><a href="#local-6989586621680958792"><span class="hs-identifier hs-var">bestChild</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
-&gt; Maybe (Type Symbol Ann) -&gt; Maybe (Type Symbol Ann)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
</span><a href="#local-6989586621680958809"><span class="hs-identifier hs-var">fallback</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">-- | Returns the type reference the given position applies to within a Decl, if any.</span><span>
</span><span id="line-339"></span><span class="hs-comment">--</span><span>
</span><span id="line-340"></span><span class="hs-comment">-- I.e. if the cursor is over a type reference within a constructor signature or ability</span><span>
</span><span id="line-341"></span><span class="hs-comment">-- request signature, that type reference will be returned.</span><span>
</span><span id="line-342"></span><span class="annot"><a href="Unison.LSP.Queries.html#refInDecl"><span class="hs-identifier hs-type">refInDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pos</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DD.Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span>
</span><span id="line-343"></span><span id="refInDecl"><span class="annot"><span class="annottext">refInDecl :: Pos -&gt; Decl Symbol Ann -&gt; Maybe TypeReference
</span><a href="Unison.LSP.Queries.html#refInDecl"><span class="hs-identifier hs-var hs-var">refInDecl</span></a></span></span><span> </span><span id="local-6989586621680958810"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958810"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Decl Symbol Ann -&gt; DataDeclaration Symbol Ann
forall v a. Decl v a -&gt; DataDeclaration v a
</span><span class="hs-identifier hs-var">DD.asDataDecl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680958812"><span class="annot"><span class="annottext">DataDeclaration Symbol Ann
</span><a href="#local-6989586621680958812"><span class="hs-identifier hs-var">dd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-344"></span><span>  </span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann -&gt; [(Ann, Symbol, Type Symbol Ann)]
forall v a. DataDeclaration v a -&gt; [(a, v, Type v a)]
</span><span class="hs-identifier hs-var">DD.constructors'</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann
</span><a href="#local-6989586621680958812"><span class="hs-identifier hs-var">dd</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><span class="annottext">[(Ann, Symbol, Type Symbol Ann)]
-&gt; ([(Ann, Symbol, Type Symbol Ann)] -&gt; Maybe TypeReference)
-&gt; Maybe TypeReference
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Ann, Symbol, Type Symbol Ann) -&gt; Maybe TypeReference)
-&gt; [(Ann, Symbol, Type Symbol Ann)] -&gt; Maybe TypeReference
forall (f :: * -&gt; *) (t :: * -&gt; *) a b.
(Alternative f, Foldable t) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f b
</span><span class="hs-identifier hs-var">altMap</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680958815"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958815"><span class="hs-identifier hs-var">_conNameAnn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958816"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680958816"><span class="hs-identifier hs-var">_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958817"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958817"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>      </span><span id="local-6989586621680958818"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958818"><span class="hs-identifier hs-var">typeNode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958810"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958817"><span class="hs-identifier hs-var">typ</span></a></span><span>
</span><span id="line-347"></span><span>      </span><span id="local-6989586621680958819"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958819"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Maybe TypeReference
forall v a. Type v a -&gt; Maybe TypeReference
</span><a href="Unison.LSP.Queries.html#refInType"><span class="hs-identifier hs-var">refInType</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680958818"><span class="hs-identifier hs-var">typeNode</span></a></span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958819"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span class="hs-comment">-- | Returns the ABT node at the provided position.</span><span>
</span><span id="line-351"></span><span class="hs-comment">-- Does not return Decl nodes.</span><span>
</span><span id="line-352"></span><span class="annot"><a href="Unison.LSP.Queries.html#nodeAtPosition"><span class="hs-identifier hs-type">nodeAtPosition</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Uri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Queries.html#SourceNode"><span class="hs-identifier hs-type">SourceNode</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span id="nodeAtPosition"><span class="annot"><span class="annottext">nodeAtPosition :: Uri -&gt; Position -&gt; MaybeT Lsp (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#nodeAtPosition"><span class="hs-identifier hs-var hs-var">nodeAtPosition</span></a></span></span><span> </span><span id="local-6989586621680958820"><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958820"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Position -&gt; Pos
</span><a href="Unison.LSP.Conversions.html#lspToUPos"><span class="hs-identifier hs-var">lspToUPos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680958821"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958821"><span class="hs-identifier hs-var">pos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FileSummary</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680958822"><span class="annot"><span class="annottext">Map
  Symbol (Ann, Maybe Id, Term Symbol Ann, Maybe (Type Symbol Ann))
termsBySymbol :: Map
  Symbol (Ann, Maybe Id, Term Symbol Ann, Maybe (Type Symbol Ann))
$sel:termsBySymbol:FileSummary :: FileSummary
-&gt; Map
     Symbol (Ann, Maybe Id, Term Symbol Ann, Maybe (Type Symbol Ann))
</span><a href="#local-6989586621680958822"><span class="hs-identifier hs-var hs-var">termsBySymbol</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958824"><span class="annot"><span class="annottext">[(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann))]
testWatchSummary :: [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann))]
$sel:testWatchSummary:FileSummary :: FileSummary
-&gt; [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
     Maybe (Type Symbol Ann))]
</span><a href="#local-6989586621680958824"><span class="hs-identifier hs-var hs-var">testWatchSummary</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958826"><span class="annot"><span class="annottext">[(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann), Maybe WatchKind)]
exprWatchSummary :: [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann), Maybe WatchKind)]
$sel:exprWatchSummary:FileSummary :: FileSummary
-&gt; [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
     Maybe (Type Symbol Ann), Maybe WatchKind)]
</span><a href="#local-6989586621680958826"><span class="hs-identifier hs-var hs-var">exprWatchSummary</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Uri -&gt; MaybeT Lsp FileSummary
</span><a href="Unison.LSP.FileAnalysis.html#getFileSummary"><span class="hs-identifier hs-var">getFileSummary</span></a></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958820"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680958828"><span class="annot"><span class="annottext">[Term Symbol Ann]
</span><a href="#local-6989586621680958828"><span class="hs-identifier hs-var">trms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958829"><span class="annot"><span class="annottext">[Type Symbol Ann]
</span><a href="#local-6989586621680958829"><span class="hs-identifier hs-var">typs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map
  Symbol (Ann, Maybe Id, Term Symbol Ann, Maybe (Type Symbol Ann))
</span><a href="#local-6989586621680958822"><span class="hs-identifier hs-var">termsBySymbol</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  Symbol (Ann, Maybe Id, Term Symbol Ann, Maybe (Type Symbol Ann))
-&gt; (Map
      Symbol (Ann, Maybe Id, Term Symbol Ann, Maybe (Type Symbol Ann))
    -&gt; ([Term Symbol Ann], [Type Symbol Ann]))
-&gt; ([Term Symbol Ann], [Type Symbol Ann])
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Ann, Maybe Id, Term Symbol Ann, Maybe (Type Symbol Ann))
 -&gt; ([Term Symbol Ann], [Type Symbol Ann]))
-&gt; Map
     Symbol (Ann, Maybe Id, Term Symbol Ann, Maybe (Type Symbol Ann))
-&gt; ([Term Symbol Ann], [Type Symbol Ann])
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; Map Symbol a -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680958831"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958831"><span class="hs-identifier hs-var">_ann</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958832"><span class="annot"><span class="annottext">Maybe Id
</span><a href="#local-6989586621680958832"><span class="hs-identifier hs-var">_ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958833"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958833"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958834"><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
</span><a href="#local-6989586621680958834"><span class="hs-identifier hs-var">mayTyp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680958833"><span class="hs-identifier hs-var">trm</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann) -&gt; [Type Symbol Ann]
forall a. Maybe a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
</span><a href="#local-6989586621680958834"><span class="hs-identifier hs-var">mayTyp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann -&gt; MaybeT Lsp (SourceNode Ann))
-&gt; [Term Symbol Ann] -&gt; MaybeT Lsp (SourceNode Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a b.
(Alternative f, Foldable t) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f b
</span><span class="hs-identifier hs-var">altMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SourceNode Ann) -&gt; MaybeT Lsp (SourceNode Ann)
forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958836"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SourceNode Ann) -&gt; MaybeT Lsp (SourceNode Ann))
-&gt; (Term Symbol Ann -&gt; Maybe (SourceNode Ann))
-&gt; Term Symbol Ann
-&gt; MaybeT Lsp (SourceNode Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958821"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann -&gt; Maybe (SourceNode Ann))
-&gt; (Term Symbol Ann -&gt; Term Symbol Ann)
-&gt; Term Symbol Ann
-&gt; Maybe (SourceNode Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Term Symbol Ann
forall v. Ord v =&gt; Term v Ann -&gt; Term v Ann
</span><a href="Unison.LSP.Queries.html#removeInferredTypeAnnotations"><span class="hs-identifier hs-var">removeInferredTypeAnnotations</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Term Symbol Ann]
</span><a href="#local-6989586621680958828"><span class="hs-identifier hs-var">trms</span></a></span><span>
</span><span id="line-358"></span><span>      </span><span class="annot"><span class="annottext">MaybeT Lsp (SourceNode Ann)
-&gt; MaybeT Lsp (SourceNode Ann) -&gt; MaybeT Lsp (SourceNode Ann)
forall a. MaybeT Lsp a -&gt; MaybeT Lsp a -&gt; MaybeT Lsp a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann -&gt; MaybeT Lsp (SourceNode Ann))
-&gt; [Term Symbol Ann] -&gt; MaybeT Lsp (SourceNode Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a b.
(Alternative f, Foldable t) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f b
</span><span class="hs-identifier hs-var">altMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SourceNode Ann) -&gt; MaybeT Lsp (SourceNode Ann)
forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958836"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SourceNode Ann) -&gt; MaybeT Lsp (SourceNode Ann))
-&gt; (Term Symbol Ann -&gt; Maybe (SourceNode Ann))
-&gt; Term Symbol Ann
-&gt; MaybeT Lsp (SourceNode Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958821"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann -&gt; Maybe (SourceNode Ann))
-&gt; (Term Symbol Ann -&gt; Term Symbol Ann)
-&gt; Term Symbol Ann
-&gt; Maybe (SourceNode Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Term Symbol Ann
forall v. Ord v =&gt; Term v Ann -&gt; Term v Ann
</span><a href="Unison.LSP.Queries.html#removeInferredTypeAnnotations"><span class="hs-identifier hs-var">removeInferredTypeAnnotations</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann))]
</span><a href="#local-6989586621680958824"><span class="hs-identifier hs-var">testWatchSummary</span></a></span><span> </span><span class="annot"><span class="annottext">[(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann))]
-&gt; Getting
     (Endo [Term Symbol Ann])
     [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
       Maybe (Type Symbol Ann))]
     (Term Symbol Ann)
-&gt; [Term Symbol Ann]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">((Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann))
 -&gt; Const
      (Endo [Term Symbol Ann])
      (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
       Maybe (Type Symbol Ann)))
-&gt; [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
     Maybe (Type Symbol Ann))]
-&gt; Const
     (Endo [Term Symbol Ann])
     [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
       Maybe (Type Symbol Ann))]
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
IndexedFold
  Int
  [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
    Maybe (Type Symbol Ann))]
  (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
   Maybe (Type Symbol Ann))
</span><span class="hs-identifier hs-var">folded</span></span><span> </span><span class="annot"><span class="annottext">(((Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
   Maybe (Type Symbol Ann))
  -&gt; Const
       (Endo [Term Symbol Ann])
       (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
        Maybe (Type Symbol Ann)))
 -&gt; [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
      Maybe (Type Symbol Ann))]
 -&gt; Const
      (Endo [Term Symbol Ann])
      [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
        Maybe (Type Symbol Ann))])
-&gt; ((Term Symbol Ann
     -&gt; Const (Endo [Term Symbol Ann]) (Term Symbol Ann))
    -&gt; (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
        Maybe (Type Symbol Ann))
    -&gt; Const
         (Endo [Term Symbol Ann])
         (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
          Maybe (Type Symbol Ann)))
-&gt; Getting
     (Endo [Term Symbol Ann])
     [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
       Maybe (Type Symbol Ann))]
     (Term Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann
 -&gt; Const (Endo [Term Symbol Ann]) (Term Symbol Ann))
-&gt; (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
    Maybe (Type Symbol Ann))
-&gt; Const
     (Endo [Term Symbol Ann])
     (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
      Maybe (Type Symbol Ann))
forall s t a b. Field4 s t a b =&gt; Lens s t a b
Lens
  (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
   Maybe (Type Symbol Ann))
  (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
   Maybe (Type Symbol Ann))
  (Term Symbol Ann)
  (Term Symbol Ann)
</span><span class="hs-identifier hs-var">_4</span></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>      </span><span class="annot"><span class="annottext">MaybeT Lsp (SourceNode Ann)
-&gt; MaybeT Lsp (SourceNode Ann) -&gt; MaybeT Lsp (SourceNode Ann)
forall a. MaybeT Lsp a -&gt; MaybeT Lsp a -&gt; MaybeT Lsp a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann -&gt; MaybeT Lsp (SourceNode Ann))
-&gt; [Term Symbol Ann] -&gt; MaybeT Lsp (SourceNode Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a b.
(Alternative f, Foldable t) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f b
</span><span class="hs-identifier hs-var">altMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SourceNode Ann) -&gt; MaybeT Lsp (SourceNode Ann)
forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958836"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SourceNode Ann) -&gt; MaybeT Lsp (SourceNode Ann))
-&gt; (Term Symbol Ann -&gt; Maybe (SourceNode Ann))
-&gt; Term Symbol Ann
-&gt; MaybeT Lsp (SourceNode Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Term Symbol Ann -&gt; Maybe (SourceNode Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingNode"><span class="hs-identifier hs-var">findSmallestEnclosingNode</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958821"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann -&gt; Maybe (SourceNode Ann))
-&gt; (Term Symbol Ann -&gt; Term Symbol Ann)
-&gt; Term Symbol Ann
-&gt; Maybe (SourceNode Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Term Symbol Ann
forall v. Ord v =&gt; Term v Ann -&gt; Term v Ann
</span><a href="Unison.LSP.Queries.html#removeInferredTypeAnnotations"><span class="hs-identifier hs-var">removeInferredTypeAnnotations</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann), Maybe WatchKind)]
</span><a href="#local-6989586621680958826"><span class="hs-identifier hs-var">exprWatchSummary</span></a></span><span> </span><span class="annot"><span class="annottext">[(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann), Maybe WatchKind)]
-&gt; Getting
     (Endo [Term Symbol Ann])
     [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
       Maybe (Type Symbol Ann), Maybe WatchKind)]
     (Term Symbol Ann)
-&gt; [Term Symbol Ann]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">((Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
  Maybe (Type Symbol Ann), Maybe WatchKind)
 -&gt; Const
      (Endo [Term Symbol Ann])
      (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
       Maybe (Type Symbol Ann), Maybe WatchKind))
-&gt; [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
     Maybe (Type Symbol Ann), Maybe WatchKind)]
-&gt; Const
     (Endo [Term Symbol Ann])
     [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
       Maybe (Type Symbol Ann), Maybe WatchKind)]
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
IndexedFold
  Int
  [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
    Maybe (Type Symbol Ann), Maybe WatchKind)]
  (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
   Maybe (Type Symbol Ann), Maybe WatchKind)
</span><span class="hs-identifier hs-var">folded</span></span><span> </span><span class="annot"><span class="annottext">(((Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
   Maybe (Type Symbol Ann), Maybe WatchKind)
  -&gt; Const
       (Endo [Term Symbol Ann])
       (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
        Maybe (Type Symbol Ann), Maybe WatchKind))
 -&gt; [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
      Maybe (Type Symbol Ann), Maybe WatchKind)]
 -&gt; Const
      (Endo [Term Symbol Ann])
      [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
        Maybe (Type Symbol Ann), Maybe WatchKind)])
-&gt; ((Term Symbol Ann
     -&gt; Const (Endo [Term Symbol Ann]) (Term Symbol Ann))
    -&gt; (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
        Maybe (Type Symbol Ann), Maybe WatchKind)
    -&gt; Const
         (Endo [Term Symbol Ann])
         (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
          Maybe (Type Symbol Ann), Maybe WatchKind))
-&gt; Getting
     (Endo [Term Symbol Ann])
     [(Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
       Maybe (Type Symbol Ann), Maybe WatchKind)]
     (Term Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Term Symbol Ann
 -&gt; Const (Endo [Term Symbol Ann]) (Term Symbol Ann))
-&gt; (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
    Maybe (Type Symbol Ann), Maybe WatchKind)
-&gt; Const
     (Endo [Term Symbol Ann])
     (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
      Maybe (Type Symbol Ann), Maybe WatchKind)
forall s t a b. Field4 s t a b =&gt; Lens s t a b
Lens
  (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
   Maybe (Type Symbol Ann), Maybe WatchKind)
  (Ann, Maybe Symbol, Maybe Id, Term Symbol Ann,
   Maybe (Type Symbol Ann), Maybe WatchKind)
  (Term Symbol Ann)
  (Term Symbol Ann)
</span><span class="hs-identifier hs-var">_4</span></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>      </span><span class="annot"><span class="annottext">MaybeT Lsp (SourceNode Ann)
-&gt; MaybeT Lsp (SourceNode Ann) -&gt; MaybeT Lsp (SourceNode Ann)
forall a. MaybeT Lsp a -&gt; MaybeT Lsp a -&gt; MaybeT Lsp a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Type Symbol Ann -&gt; MaybeT Lsp (SourceNode Ann))
-&gt; [Type Symbol Ann] -&gt; MaybeT Lsp (SourceNode Ann)
forall (f :: * -&gt; *) (t :: * -&gt; *) a b.
(Alternative f, Foldable t) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f b
</span><span class="hs-identifier hs-var">altMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type Symbol Ann -&gt; SourceNode Ann)
-&gt; MaybeT Lsp (Type Symbol Ann) -&gt; MaybeT Lsp (SourceNode Ann)
forall a b. (a -&gt; b) -&gt; MaybeT Lsp a -&gt; MaybeT Lsp b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; SourceNode Ann
forall a. Type Symbol a -&gt; SourceNode a
</span><a href="Unison.LSP.Queries.html#TypeNode"><span class="hs-identifier hs-var">TypeNode</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeT Lsp (Type Symbol Ann) -&gt; MaybeT Lsp (SourceNode Ann))
-&gt; (Type Symbol Ann -&gt; MaybeT Lsp (Type Symbol Ann))
-&gt; Type Symbol Ann
-&gt; MaybeT Lsp (SourceNode Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann) -&gt; MaybeT Lsp (Type Symbol Ann)
forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958836"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Type Symbol Ann) -&gt; MaybeT Lsp (Type Symbol Ann))
-&gt; (Type Symbol Ann -&gt; Maybe (Type Symbol Ann))
-&gt; Type Symbol Ann
-&gt; MaybeT Lsp (Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type Symbol Ann -&gt; Maybe (Type Symbol Ann)
</span><a href="Unison.LSP.Queries.html#findSmallestEnclosingType"><span class="hs-identifier hs-var">findSmallestEnclosingType</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680958821"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type Symbol Ann]
</span><a href="#local-6989586621680958829"><span class="hs-identifier hs-var">typs</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-363"></span><span>    </span><span id="local-6989586621680958839"><span class="annot"><a href="#local-6989586621680958836"><span class="hs-identifier hs-type">hoistMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680958839"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680958839"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621680958836"><span class="annot"><span class="annottext">hoistMaybe :: forall a. Maybe a -&gt; MaybeT Lsp a
</span><a href="#local-6989586621680958836"><span class="hs-identifier hs-var hs-var">hoistMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lsp (Maybe a) -&gt; MaybeT Lsp a
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(Lsp (Maybe a) -&gt; MaybeT Lsp a)
-&gt; (Maybe a -&gt; Lsp (Maybe a)) -&gt; Maybe a -&gt; MaybeT Lsp a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Lsp (Maybe a)
forall a. a -&gt; Lsp a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="annot"><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-type">annIsFilePosition</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-367"></span><span id="annIsFilePosition"><span class="annot"><span class="annottext">annIsFilePosition :: Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var hs-var">annIsFilePosition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-368"></span><span>  </span><span class="annot"><span class="annottext">Ann
</span><span class="hs-identifier hs-var">Ann.Intrinsic</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IsTop
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-369"></span><span>  </span><span class="annot"><span class="annottext">Ann
</span><span class="hs-identifier hs-var">Ann.External</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IsTop
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-370"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IsTop
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-371"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ann.GeneratedFrom</span></span><span> </span><span id="local-6989586621680958845"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958845"><span class="hs-identifier hs-var">ann</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; IsTop
</span><a href="Unison.LSP.Queries.html#annIsFilePosition"><span class="hs-identifier hs-var">annIsFilePosition</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680958845"><span class="hs-identifier hs-var">ann</span></a></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="hs-comment">-- | Okay, so currently during synthesis in typechecking the typechecker adds `Ann` nodes</span><span>
</span><span id="line-374"></span><span class="hs-comment">-- to the term specifying types of subterms. This is a problem because we the types in these</span><span>
</span><span id="line-375"></span><span class="hs-comment">-- Ann nodes are just tagged with the full `Ann` from the term it was inferred for, even</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- though none of these types exist in the file, and at a glance we can't tell whether a type</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- is inferred or user-specified.</span><span>
</span><span id="line-378"></span><span class="hs-comment">--</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- So for now we crawl the term and remove any Ann nodes from within. The downside being you</span><span>
</span><span id="line-380"></span><span class="hs-comment">-- can no longer hover on Type signatures within a term, but the benefit is that hover</span><span>
</span><span id="line-381"></span><span class="hs-comment">-- actually works.</span><span>
</span><span id="line-382"></span><span id="local-6989586621680958049"><span class="annot"><a href="Unison.LSP.Queries.html#removeInferredTypeAnnotations"><span class="hs-identifier hs-type">removeInferredTypeAnnotations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680958049"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><a href="#local-6989586621680958049"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><a href="#local-6989586621680958049"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span></span><span>
</span><span id="line-383"></span><span id="removeInferredTypeAnnotations"><span class="annot"><span class="annottext">removeInferredTypeAnnotations :: forall v. Ord v =&gt; Term v Ann -&gt; Term v Ann
</span><a href="Unison.LSP.Queries.html#removeInferredTypeAnnotations"><span class="hs-identifier hs-var hs-var">removeInferredTypeAnnotations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-384"></span><span>  </span><span class="annot"><span class="annottext">ASetter (Term v Ann) (Term v Ann) (Term v Ann) (Term v Ann)
-&gt; (Term v Ann -&gt; Term v Ann) -&gt; Term v Ann -&gt; Term v Ann
forall a b. ASetter a b a b -&gt; (b -&gt; b) -&gt; a -&gt; b
</span><span class="hs-identifier hs-var">Lens.transformOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;out&quot;</span></span><span> </span><span class="annot"><span class="annottext">((ABT (F v Ann Ann) v (Term v Ann)
  -&gt; Identity (ABT (F v Ann Ann) v (Term v Ann)))
 -&gt; Term v Ann -&gt; Identity (Term v Ann))
-&gt; ((Term v Ann -&gt; Identity (Term v Ann))
    -&gt; ABT (F v Ann Ann) v (Term v Ann)
    -&gt; Identity (ABT (F v Ann Ann) v (Term v Ann)))
-&gt; ASetter (Term v Ann) (Term v Ann) (Term v Ann) (Term v Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Term v Ann -&gt; Identity (Term v Ann))
-&gt; ABT (F v Ann Ann) v (Term v Ann)
-&gt; Identity (ABT (F v Ann Ann) v (Term v Ann))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (ABT (F v Ann Ann) v (Term v Ann))
  (ABT (F v Ann Ann) v (Term v Ann))
  (Term v Ann)
  (Term v Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ABT.Term</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">out :: forall (f :: * -&gt; *) v a. Term f v a -&gt; ABT f v (Term f v a)
</span><span class="hs-identifier hs-var">out</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ABT.Tm</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.Ann</span></span><span> </span><span id="local-6989586621680958900"><span class="annot"><span class="annottext">Term v Ann
</span><a href="#local-6989586621680958900"><span class="hs-identifier hs-var">trm</span></a></span></span><span> </span><span id="local-6989586621680958901"><span class="annot"><span class="annottext">Type v Ann
</span><a href="#local-6989586621680958901"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-386"></span><span>      </span><span class="hs-comment">-- If the type's annotation is identical to the term's annotation, then this must be an inferred type</span><span>
</span><span id="line-387"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type v Ann -&gt; Ann
forall (f :: * -&gt; *) v a. Term f v a -&gt; a
</span><span class="hs-identifier hs-var">ABT.annotation</span></span><span> </span><span class="annot"><span class="annottext">Type v Ann
</span><a href="#local-6989586621680958901"><span class="hs-identifier hs-var">typ</span></a></span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Ann -&gt; IsTop
forall a. Eq a =&gt; a -&gt; a -&gt; IsTop
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Term v Ann -&gt; Ann
forall (f :: * -&gt; *) v a. Term f v a -&gt; a
</span><span class="hs-identifier hs-var">ABT.annotation</span></span><span> </span><span class="annot"><span class="annottext">Term v Ann
</span><a href="#local-6989586621680958900"><span class="hs-identifier hs-var">trm</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term v Ann
</span><a href="#local-6989586621680958900"><span class="hs-identifier hs-var">trm</span></a></span><span>
</span><span id="line-388"></span><span>    </span><span id="local-6989586621680958902"><span class="annot"><span class="annottext">Term v Ann
</span><a href="#local-6989586621680958902"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term v Ann
</span><a href="#local-6989586621680958902"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span class="annot"><span class="hs-comment">-- | Renders all docs for a given FQN to markdown.</span></span><span>
</span><span id="line-391"></span><span class="annot"><a href="Unison.LSP.Queries.html#markdownDocsForFQN"><span class="hs-identifier hs-type">markdownDocsForFQN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Uri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HQ.HashQualified</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span>
</span><span id="line-392"></span><span id="markdownDocsForFQN"><span class="annot"><span class="annottext">markdownDocsForFQN :: Uri -&gt; HashQualified Name -&gt; Lsp [Text]
</span><a href="Unison.LSP.Queries.html#markdownDocsForFQN"><span class="hs-identifier hs-var hs-var">markdownDocsForFQN</span></a></span></span><span> </span><span id="local-6989586621680958903"><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958903"><span class="hs-identifier hs-var">fileUri</span></a></span></span><span> </span><span id="local-6989586621680958904"><span class="annot"><span class="annottext">HashQualified Name
</span><a href="#local-6989586621680958904"><span class="hs-identifier hs-var">fqn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-393"></span><span>  </span><span class="annot"><span class="annottext">[Text] -&gt; Maybe [Text] -&gt; [Text]
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Maybe [Text] -&gt; [Text]) -&gt; Lsp (Maybe [Text]) -&gt; Lsp [Text]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp [Text] -&gt; Lsp (Maybe [Text])
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621680958907"><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680958907"><span class="hs-identifier hs-var">pped</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lsp PrettyPrintEnvDecl -&gt; MaybeT Lsp PrettyPrintEnvDecl
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Lsp PrettyPrintEnvDecl -&gt; MaybeT Lsp PrettyPrintEnvDecl)
-&gt; Lsp PrettyPrintEnvDecl -&gt; MaybeT Lsp PrettyPrintEnvDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Uri -&gt; Lsp PrettyPrintEnvDecl
</span><a href="Unison.LSP.FileAnalysis.html#ppedForFile"><span class="hs-identifier hs-var">ppedForFile</span></a></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621680958903"><span class="hs-identifier hs-var">fileUri</span></a></span><span>
</span><span id="line-395"></span><span>    </span><span id="local-6989586621680958909"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680958909"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lsp (Maybe Name) -&gt; MaybeT Lsp Name
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(Lsp (Maybe Name) -&gt; MaybeT Lsp Name)
-&gt; (Maybe Name -&gt; Lsp (Maybe Name))
-&gt; Maybe Name
-&gt; MaybeT Lsp Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name -&gt; Lsp (Maybe Name)
forall a. a -&gt; Lsp a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Name -&gt; MaybeT Lsp Name) -&gt; Maybe Name -&gt; MaybeT Lsp Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashQualified Name -&gt; Maybe Name
forall n. HashQualified n -&gt; Maybe n
</span><span class="hs-identifier hs-var">HQ.toName</span></span><span> </span><span class="annot"><span class="annottext">HashQualified Name
</span><a href="#local-6989586621680958904"><span class="hs-identifier hs-var">fqn</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span id="local-6989586621680958911"><span class="annot"><span class="annottext">NameSearch Transaction
</span><a href="#local-6989586621680958911"><span class="hs-identifier hs-var">nameSearch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lsp (NameSearch Transaction) -&gt; MaybeT Lsp (NameSearch Transaction)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Lsp (NameSearch Transaction)
 -&gt; MaybeT Lsp (NameSearch Transaction))
-&gt; Lsp (NameSearch Transaction)
-&gt; MaybeT Lsp (NameSearch Transaction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lsp (NameSearch Transaction)
</span><a href="Unison.LSP.Types.html#getNameSearch"><span class="hs-identifier hs-var">getNameSearch</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680958913"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
$sel:codebase:Env :: Env -&gt; Codebase IO Symbol Ann
codebase :: Codebase IO Symbol Ann
</span><a href="Unison.LSP.Types.html#%24sel%3Acodebase%3AEnv"><span class="hs-identifier hs-var hs-var">codebase</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958914"><span class="annot"><span class="annottext">Runtime Symbol
runtime :: Runtime Symbol
$sel:runtime:Env :: Env -&gt; Runtime Symbol
</span><a href="#local-6989586621680958914"><span class="hs-identifier hs-var hs-var">runtime</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MaybeT Lsp Env
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-398"></span><span>    </span><span class="annot"><span class="annottext">IO [Text] -&gt; MaybeT Lsp [Text]
forall a. IO a -&gt; MaybeT Lsp a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO [Text] -&gt; MaybeT Lsp [Text]) -&gt; IO [Text] -&gt; MaybeT Lsp [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-399"></span><span>      </span><span id="local-6989586621680958916"><span class="annot"><span class="annottext">[TypeReference]
</span><a href="#local-6989586621680958916"><span class="hs-identifier hs-var">docRefs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Transaction [TypeReference] -&gt; IO [TypeReference]
forall (m :: * -&gt; *) v a b.
MonadIO m =&gt;
Codebase m v a -&gt; Transaction b -&gt; m b
</span><span class="hs-identifier hs-var">Codebase.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680958913"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction [TypeReference] -&gt; IO [TypeReference])
-&gt; Transaction [TypeReference] -&gt; IO [TypeReference]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; NameSearch Transaction
-&gt; SearchType
-&gt; Name
-&gt; Transaction [TypeReference]
</span><span class="hs-identifier hs-var">Backend.docsForDefinitionName</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680958913"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">NameSearch Transaction
</span><a href="#local-6989586621680958911"><span class="hs-identifier hs-var">nameSearch</span></a></span><span> </span><span class="annot"><span class="annottext">SearchType
</span><span class="hs-identifier hs-var">ExactName</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680958909"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-400"></span><span>      </span><span class="annot"><span class="annottext">[TypeReference] -&gt; (TypeReference -&gt; IO Text) -&gt; IO [Text]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">[TypeReference]
</span><a href="#local-6989586621680958916"><span class="hs-identifier hs-var">docRefs</span></a></span><span> </span><span class="annot"><span class="annottext">((TypeReference -&gt; IO Text) -&gt; IO [Text])
-&gt; (TypeReference -&gt; IO Text) -&gt; IO [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680958920"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958920"><span class="hs-identifier hs-var">docRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-401"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958922"><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621680958922"><span class="hs-identifier hs-var">doc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680958923"><span class="annot"><span class="annottext">[Error]
</span><a href="#local-6989586621680958923"><span class="hs-identifier hs-var">_evalErrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
-&gt; Width
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Identity TypeReference
-&gt; IO (Identity (Text, Text, Doc, [Error]))
forall (t :: * -&gt; *).
Traversable t =&gt;
PrettyPrintEnvDecl
-&gt; Width
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; t TypeReference
-&gt; IO (t (Text, Text, Doc, [Error]))
</span><span class="hs-identifier hs-var">Backend.renderDocRefs</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680958907"><span class="hs-identifier hs-var">pped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Width
</span><span class="hs-identifier hs-var">Pretty.Width</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">80</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680958913"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621680958914"><span class="hs-identifier hs-var">runtime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeReference -&gt; Identity TypeReference
forall a. a -&gt; Identity a
</span><span class="hs-identifier hs-var">Identity</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680958920"><span class="hs-identifier hs-var">docRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; IO Text
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO Text) -&gt; ([Markdown] -&gt; Text) -&gt; [Markdown] -&gt; IO Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Markdown] -&gt; Text
</span><span class="hs-identifier hs-var">Md.toText</span></span><span> </span><span class="annot"><span class="annottext">([Markdown] -&gt; IO Text) -&gt; [Markdown] -&gt; IO Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Markdown]
</span><span class="hs-identifier hs-var">Md.toMarkdown</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621680958922"><span class="hs-identifier hs-var">doc</span></a></span><span>
</span><span id="line-403"></span></pre></body></html>